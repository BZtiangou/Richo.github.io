<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>深度学习 | Richo blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="Richo's Blog" />
  
  <meta name="description" content="深度学习：背景知识一.张量、向量、标量的区别 标量，向量，矩阵它们三个也是张量，标量是零维的张量，向量是一维的张量，矩阵是二维的张量。 二.卷积核（kernel）和过滤器（filter）的区别  卷积核就是由长和宽来指定的，是一个二维的概念。 而过滤器是是由长、宽和深度指定的，是一个三维的概念。 过滤器可以看做是卷积核的集合。 过滤器比卷积核高一个维度——深度。   如上图: 上述操作描述了对一张">
<meta property="og:type" content="article">
<meta property="og:title" content="深度学习">
<meta property="og:url" content="https://bztiangou.github.io/Richo.github.io/2023/11/13/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%EF%BC%9A/index.html">
<meta property="og:site_name" content="Richo blog">
<meta property="og:description" content="深度学习：背景知识一.张量、向量、标量的区别 标量，向量，矩阵它们三个也是张量，标量是零维的张量，向量是一维的张量，矩阵是二维的张量。 二.卷积核（kernel）和过滤器（filter）的区别  卷积核就是由长和宽来指定的，是一个二维的概念。 而过滤器是是由长、宽和深度指定的，是一个三维的概念。 过滤器可以看做是卷积核的集合。 过滤器比卷积核高一个维度——深度。   如上图: 上述操作描述了对一张">
<meta property="og:locale">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201121195053531.gif#pic_center">
<meta property="og:image" content="c:\Users\86176\AppData\Roaming\Typora\typora-user-images\image-20240223115703500.png">
<meta property="og:image" content="c:\Users\86176\AppData\Roaming\Typora\typora-user-images\image-20240223115757242.png">
<meta property="og:image" content="c:\Users\86176\AppData\Roaming\Typora\typora-user-images\image-20240223115831484.png">
<meta property="article:published_time" content="2023-11-12T16:00:00.000Z">
<meta property="article:modified_time" content="2024-02-23T04:01:27.982Z">
<meta property="article:author" content="Richo">
<meta property="article:tag" content="大创">
<meta property="article:tag" content="深度学习">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/20201121195053531.gif#pic_center">
  
  
    <link rel="icon" href="images/head.jpg">
  
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  
<link rel="stylesheet" href="/Richo.github.io/css/style.css">

  
<script src="/Richo.github.io/js/pace.min.js"></script>

  

  
  

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
      <header id="header">
    <div id="banner"></div>
    <div id="header-outer">
        <div id="header-menu" class="header-menu-pos animated">
            <div class="header-menu-container">
                <a href="/Richo.github.io/" class="left">
                    <span class="site-title">Richo&#39;s Blog</span>
                </a>
                <nav id="header-menu-nav" class="right">
                    
                    <a  href="/Richo.github.io/">
                        <i class="fa fa-home"></i>
                        <span>Home</span>
                    </a>
                    
                    <a  href="/Richo.github.io/archives">
                        <i class="fa fa-archive"></i>
                        <span>Archives</span>
                    </a>
                    
                    <a  href="/Richo.github.io/about">
                        <i class="fa fa-user"></i>
                        <span>About</span>
                    </a>
                    
                </nav>
                <a class="mobile-header-menu-button">
                    <i class="fa fa-bars"></i>
                </a>
            </div>
        </div>
        <div id="header-row">
            <div id="logo">
                <a href="/Richo.github.io/">
                    <img src="/Richo.github.io/images/head.jpg" alt="logo">
                </a>
            </div>
            <div class="header-info">
                <div id="header-title">
                    
                    <h2>
                        Richo&#39;s Blog
                    </h2>
                    
                </div>
                <div id="header-description">
                    
                    <h3>
                        新手上路，不服憋着
                    </h3>
                    
                </div>
            </div>
            <nav class="header-nav">
                <div class="social">
                    
                        <a title="githubtoo" target="_blank" href="https://github.com/BZtiangou/">
                            <i class="fa fa-home fa-2x"></i></a>
                    
                        <a title="Github" target="_blank" href="https://github.com/BZtiangou/">
                            <i class="fa fa-github fa-2x"></i></a>
                    
                        <a title="Weibo"  target="_blank" rel="noopener" href="//weibo.com/WongMinHo">
                            <i class="fa fa-weibo fa-2x"></i></a>
                    
                        <a title="Twitter"  target="_blank" rel="noopener" href="//twitter.com/huangminhow">
                            <i class="fa fa-twitter fa-2x"></i></a>
                    
                </div>
            </nav>
        </div>
    </div>
</header>
      <div class="outer">
        <section id="main" class="body-wrap"><article id="post-深度学习：" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="post-title" itemprop="name">
      深度学习
    </h1>
    <div class="post-title-bar">
      <ul>
          
              <li>
                  <i class="fa fa-book"></i>
                  
                      <a href="/Richo.github.io/categories/深度学习/">深度学习</a>
                  
              </li>
          
        <li>
          <i class="fa fa-calendar"></i>  2023-11-13
        </li>
        <li>
          <i class="fa fa-eye"></i>
          <span id="busuanzi_value_page_pv"></span>
        </li>
      </ul>
    </div>
  

          
      </header>
    
    <div class="article-entry post-content" itemprop="articleBody">
      
            
            <h1 id="深度学习："><a href="#深度学习：" class="headerlink" title="深度学习："></a>深度学习：</h1><h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p><strong>一.张量、向量、标量的区别</strong></p>
<p>标量，向量，矩阵它们三个也是张量，标量是零维的张量，向量是一维的张量，矩阵是二维的张量。</p>
<p><strong>二.卷积核（kernel）和过滤器（filter）的区别</strong></p>
<ul>
<li>卷积核就是由长和宽来指定的，是一个二维的概念。</li>
<li>而过滤器是是由长、宽和深度指定的，是一个三维的概念。</li>
<li>过滤器可以看做是卷积核的集合。</li>
<li>过滤器比卷积核高一个维度——深度。</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20201121195053531.gif#pic_center" alt="kernel 与 filter"></p>
<p>如上图:</p>
<p>上述操作描述了对一张RGB（三通道）图像进行卷积操作的过程。具体地，使用了三个大小为 3 × 3 的卷积核，每个卷积核对应一个通道。这三个卷积核分别在红色通道、绿色通道和蓝色通道上进行卷积操作，得到三个单通道的特征图。然后，将这三个特征图逐元素相加，得到最终的合成特征图。这个合成特征图捕捉了输入图像的不同通道上的特征信息，通过这样的操作，我们可以更全面地理解图像中的结构和内容。这整个过程中，<strong>三个卷积核的集合称为过滤器</strong>，而<strong>每个过滤器对应生成一个最终的特征图</strong>。</p>
<p>但是如果是在单通道情况下，其实过滤器和卷积核可以看做一个东西，即 filter&#x3D;kernel 。</p>
<p><strong>三.范数</strong></p>
<p>一般地可以认为范数可以描述两个量之间的距离关系。</p>
<p><strong>四.卷积核的深度与通道数</strong></p>
<p>卷积核的深度”就是该层输入的featuremap的通道数。“卷积核的数量”和“输出深度”是相同的，即一个卷积核对应一层输出。</p>
<p><strong>输入数据的通道数</strong> (有时候也叫深度)决定了卷积核的通道数。 2.<strong>输出的通道数</strong> (最右边的那六张图)是由<strong>多少个</strong>卷积核来决定的。</p>
<p><strong>五.模型量化</strong></p>
<p>模型量化在最初的定义里是为了压缩模型参数，比如韩松在ICLR2016上获得best paper的论文，首次提出了参数量化方法。其使用k-mean聚类，让相近的数值聚类到同一个聚类中心，复用同一个数值，从而达到用更少的数值表示更多的数，这是量化操作的一种方案。反过来，从量化数变到原始数的过程，称之为反量化，反量化操作完之后，模型就可以按照原来的方式进行正常的计算。</p>
<p>我们认为绝大部分的模型量化算法都能压缩参数，因此压缩参数的实用性不存在问题。</p>
<p><strong>六.优化器</strong></p>
<p>优化器是深度学习中用于调整模型参数以最小化损失函数的算法。其主要目标是通过不断调整模型参数，使得模型在训练数据上的损失逐渐减小，从而提高模型的性能。</p>
<p>在 PyTorch 中，可以使用 <code>torch.optim</code> 模块来实现各种优化器，例如 <code>SGD</code>、<code>Adam</code> 等。这些优化器会在训练过程中不断更新模型参数，以最小化损失函数。</p>
<p><strong>七.随机种子</strong></p>
<p>通常用于初始化随机数生成器，使得每次运行程序时得到的随机结果是可复现的。在深度学习中，使用随机种子可以确保在相同的初始条件下每次运行训练过程得到相同的结果，这对于实验的可重复性和结果的比较非常重要。</p>
<p><strong>八.batch</strong></p>
<p>batch，翻译成汉语为批（<strong>一批一批的批</strong>）。 在神经网络模型训练时，比如有1000个样本，把这些样本分为10批，就是10个batch。 每个批（batch）的大小为100，就是batch size&#x3D;100。</p>
<p><strong>九.marginal cost (边际成本)</strong> </p>
<p>每增加一次数据量（batch_size大小、图片大小、Region Proposal个数等等），<br>所造成的计算总成本（time cost 或 memory cost）的增量。</p>
<p>十.上采样和下采样</p>
<p><strong>上采样就是重采样也就是放大图像</strong></p>
<p><strong>下采样就是降采样，对于一幅图像尺寸为M*N，对其进行s倍下采样，即得到(M&#x2F;s)*(N&#x2F;s)尺寸的得分辨率图像</strong></p>
<h3 id="卷积神经网络和神经网络的区别："><a href="#卷积神经网络和神经网络的区别：" class="headerlink" title="卷积神经网络和神经网络的区别："></a>卷积神经网络和神经网络的区别：</h3><p>CNN主要专注于处理具有网格结构的数据，能够更好地捕捉输入数据的空间结构和局部特征，而神经网络（MLP）则是一种更通用的结构，适用于各种深度学习任务，但对于图像等具有明显结构的数据，CNN通常更为有效。在实际应用中，这两种结构也可以组合使用，构建更为复杂的深度学习模型。</p>
<h3 id="整体架构："><a href="#整体架构：" class="headerlink" title="整体架构："></a>整体架构：</h3><ol>
<li><h4 id="输入层：字面意思"><a href="#输入层：字面意思" class="headerlink" title="输入层：字面意思"></a><strong>输入层</strong>：字面意思</h4></li>
<li><h4 id="卷积层："><a href="#卷积层：" class="headerlink" title="卷积层："></a><strong>卷积层</strong>：</h4><p>这里要牵扯到一个术语叫<strong>卷积核</strong>，卷积核理解成，你要提取什么特征，卷积核就长什么样。(你说你要买凶杀人，总不能连照片都不给杀手吧) 卷积核的组成是一个矩阵，用于和输入进行计算，注意是点积而不是矩阵乘法。卷积核的size, 比如3x3x3 就是表示我要以3x3作为一部分区域进行计算，第三个维度的3则表示input 的第三个维度，两则必须相等。对于输出图像，也叫特征图的size而言有三个维度：x,y,z，前两个维度显然可以用数学公式总结出来：对于步长为一的时候，特征比较丰富。<br>$$<br>x&#x3D;x_1-x_2+1<br>$$</p>
<p>$$<br>        y&#x3D;y_1-y_2+1<br>$$</p>
<p>其中x1等于原图像的一维，x2是卷积核。z是特征图的个数</p>
<p>然后你就会发现图片越来越小了，如果需要恢复的话就需要用到<strong>padding</strong>:一种是valid，另一种是same。valid模式即是输出的图像不需要与原图像大小相等，same模式即是输出的图像需要与原图像大小相等。但是要在图像周围填充多少层0才能保证输出的图像与原图像等大小呢。也是有公式。为什么要在周围填充？因为中间的数据对结果的贡献更多。</p>
<p>刚刚我们的点积操作是对于一步一步移动而言，其实我们还可以跳步。如果2格2格移动，输出的图像更小的，7<em>7的输入图像，最后输出是3</em>3的图像，因此输入与输出图像之间的关系，公式需要更新。</p>
<p>当然卷积核也可以不止一个，同时对于每一个颜色通道也可以使用不同的卷积核进行卷积，但是输出只有一个，所以记得要把输出矩阵的对应位置的结果进行相加。你也可以设置一个常数b，在对应位置相加时记得加上。但是<strong>对于同一个卷积层，不是中间卷积！</strong>你的卷积核规格必须是相同的，不能对一个图像进行3x3的卷积的同时也进行4x4的卷积。</p>
<p><strong>中间卷积</strong>：进一步特征提取。就是把上一次的结果当成这一次的input进行卷积，这个时候你的卷积核可以采取新的size,但是得提一嘴因为你的input的第三维度可能过高，所以最后出来的第三维度过高也是正常的。</p>
<p>综上我们可以得到卷积结果计算公式：<br>$$<br>H_2&#x3D;(H_1-F_H+2P)&#x2F;S+1<br>$$</p>
<p>$$<br>W_2&#x3D;(W_1-F_W+2P)&#x2F;S+1<br>$$</p>
</li>
</ol>
<p>其中下标是1表示输入，2表示输出特征图，F表示卷积核</p>
<p><strong>卷积参数共享</strong>：意思是对于每一个小区域都是用同一个卷积核进行卷积，可以省下巨额时间花费，权重参数比较少。</p>
<ol start="3">
<li><h4 id="池化层："><a href="#池化层：" class="headerlink" title="池化层："></a>池化层：</h4><p>简单描述：压缩。</p>
<p>最大池化：选择不同区域size自选，直接选择最大值最为那个区域的代表。很常用。</p>
</li>
<li><h4 id="全连接层FC："><a href="#全连接层FC：" class="headerlink" title="全连接层FC："></a>全连接层FC：</h4><p>简单描述：图像搞来搞去也还是图像，我们要的是结果！总不能人脸识别出来的结果是你的图片吧。</p>
<p>这时候就需要全连接层把图像映射成一个结果，像or不像？或者是其他你想要的结果。</p>
<p>拉长：也即处理特征图，没见过一个长方体和矩阵相乘吧？没见过就对了，我也没见过。所以我们在全连接之前需要对特征图进行拉长。就是转换成一个向量，因为它巨长，所以这个操作被称为拉长。然后就可以跟矩阵相乘得到结果。</p>
</li>
</ol>
<h2 id="什么是神经网络"><a href="#什么是神经网络" class="headerlink" title="什么是神经网络"></a>什么是神经网络</h2><p>了解神经网络：实现目的的一个工具。<strong>神经网络的特征之一，就是从数据样本中学习。</strong>也就是说，可以由训练数据来自动确定网络权值参数的值。</p>
<p>深度学习：训练神经网络的过程</p>
<p>优化算法：</p>
<p>求解微分方程并不是计算机所长。计算机所擅长的是，<strong>凭借强大的计算能力</strong>，通过插值等方法（如牛顿下山法、弦截法等），<strong>海量尝试，一步一步的去把函数的极值点“试”出来</strong>。</p>
<p>如果某个问题的解确定存在，而帮助我们快速找到这个解的算法，我们都可以称之为“优化算法”。BP算法、Adam算法等都输入优化算法之列，而delta法则是最早使用的优化算法之一。</p>
<p>delta法则的核心思想在于，<strong>使用梯度下降（gradient descent）的方法找极值。</strong></p>
<h2 id="用神经网络进行监督学习"><a href="#用神经网络进行监督学习" class="headerlink" title="用神经网络进行监督学习"></a>用神经网络进行监督学习</h2><p>标准神经网络，卷积神经网络，循环神经网络</p>
<p>结构化数据：数据库</p>
<p>非结构化数据：音频，图片，文本</p>
<h2 id="二分分类算法"><a href="#二分分类算法" class="headerlink" title="二分分类算法"></a>二分分类算法</h2><p>逻辑回归：</p>
<p>目的：对于一张图片，判断是否有只猫在其中，结果为0&#x2F;1</p>
<p>过程包括特征向量提取 ：</p>
<p>对三颜色图片来说：就是把BGR三颜色通道的所有颜色的像素提取出来，放在一个向量空间中，其中维度&#x3D;长 x 宽 x3(三个颜色通道)</p>
<p>术语部分：</p>
<p>用一对(x,y)来表示样本，其中x是n维度的特征向量，y是标签</p>
<p>训练集有m个训练样本组成  ：  m&#x3D;m_train （方便表示m是训练样本的个数） m_test（则是表示测试集合的个数）</p>
<p>用X表示一个(训练)矩阵，其中X是由n维度的特征向量x列堆叠而成，也可以通过转置变成行堆叠。</p>
<p>用Y表示一个(标签)矩阵，同上</p>
<h2 id="logistic-回归"><a href="#logistic-回归" class="headerlink" title="logistic 回归"></a>logistic 回归</h2><p>sigmoid函数：将结果映射到0-1的光滑函数  </p>
<p>长这样：</p>
<p>S(x)&#x3D;1&#x2F;(1+e^{-x})^2</p>
<p>y&#x3D;k^t *x+b  &#x3D;&gt; y&#x3D; sigmoid(z)   z&#x3D;k^t *x+b    通过这种包装来使得当z接近无穷大的时候y-&gt;1  and z-&gt;-无穷 , y-&gt;0</p>
<p>回归损失函数：</p>
<p>是衡量预测值和实际值之间的距离，可以+平方。L（y,y^）</p>
<p>成本函数：</p>
<p>衡量在全体训练样本上的表现 J(w,b)</p>
<p>梯度下降法：</p>
<p>在W和b组成的空间中，找到最优的解</p>
<p>计算：对单样本计算后，求平均(可能需要两个for，比较费资源)</p>
<p>python 的numpy能充分利用并行化去更快计算</p>
<p>numpy:</p>
<p>u&#x3D;np.exp(v)  把v矩阵经过某种变换后映射到u矩阵中</p>
<h2 id="神经网络的概述和表示"><a href="#神经网络的概述和表示" class="headerlink" title="神经网络的概述和表示"></a>神经网络的概述和表示</h2><p>最简单的：包括输入层，隐藏层，输出层</p>
<p>隐藏层是因为在训练集看不到他们的信息</p>
<p>隐藏层里面的每个值(图示圆圈)称为隐藏单元</p>
<p>激活值：传递给下一层的值</p>
<p>所以x&#x3D;a^{[0]}</p>
<p>神经网络的不同层次做的每一步是差不多一样：不断计算 得到激活值然后激活下一层</p>
<h2 id="激活函数"><a href="#激活函数" class="headerlink" title="激活函数"></a>激活函数</h2><p>sigoma   tanh  ReLu</p>
<p>不知道用那个就用Relu，修正线性，在x属于与无穷到0时，导数为0，反之导数为一</p>
<p>tanh &gt; sigoma 函数</p>
<p>为什么需要？</p>
<p>在隐藏层里一般都需要进行非线性的变换，也就是激活函数的使用，不然就是线性函数之间的自由组合，结果没有意义</p>
<h2 id="随机初始化"><a href="#随机初始化" class="headerlink" title="随机初始化"></a>随机初始化</h2><p>如果w是0，则多个隐藏单元都是在计算同一个东西，没有意义，具有对称性</p>
<p>W初始过大会减慢学习效率，一开始就过于饱和，w*0.01</p>
<p>b可以是0</p>
<h2 id="前向和反向传播"><a href="#前向和反向传播" class="headerlink" title="前向和反向传播"></a>前向和反向传播</h2><p>样本和结果都写成列向量，横向排 </p>
<p>计算过程可以用for显示调用</p>
<p>前向传播是由输入得到输出的过程</p>
<p>反向则是损失函数计算，对模型权重进行优化</p>
<h2 id="核对矩阵维数"><a href="#核对矩阵维数" class="headerlink" title="核对矩阵维数"></a>核对矩阵维数</h2><p>计算w的值，使得x*w的值符合预期</p>
<h2 id="为什么用深度表示"><a href="#为什么用深度表示" class="headerlink" title="为什么用深度表示"></a>为什么用深度表示</h2><p>深度&#x3D;&#x3D;隐藏层数</p>
<p>以构建人脸识别系统为例：前几层有可能是识别局部，比如鼻子，后几层可能是整合，由简单到复杂</p>
<p>层数的多少和参数的选择一样是需要思考</p>
<h2 id="搭建模块"><a href="#搭建模块" class="headerlink" title="搭建模块"></a>搭建模块</h2><p>需要缓存z的值，w和b的值以备用</p>
<h2 id="超参数和参数"><a href="#超参数和参数" class="headerlink" title="超参数和参数"></a>超参数和参数</h2><p>1.什么是超参数？</p>
<p>2.学习率α</p>
<p>3.循环的数量</p>
<p>4.隐藏层数量和5.单元数目</p>
<p>6.选择那些激活函数</p>
<p>这些最终能控制W和B的值的都叫做超参数</p>
<p>多次调解学习率α 0.01 什么的，观察损失值，最后得出比较优秀的学习率</p>
<h1 id="mobilenetV2"><a href="#mobilenetV2" class="headerlink" title="mobilenetV2"></a>mobilenetV2</h1><h2 id="创建mobilenetV2网络结构"><a href="#创建mobilenetV2网络结构" class="headerlink" title="创建mobilenetV2网络结构"></a>创建mobilenetV2网络结构</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回一个由卷积、批归一化和ReLU激活组成的序列。这些函数用于构建模型中的卷积块</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">conv_bn</span>(<span class="params">inp, oup, stride</span>):</span><br><span class="line">    <span class="keyword">return</span> nn.Sequential(</span><br><span class="line">        nn.Conv2d(inp, oup, <span class="number">3</span>, stride, <span class="number">1</span>, bias=<span class="literal">False</span>),  <span class="comment"># 3x3卷积层，步幅为stride，填充为1，无偏置</span></span><br><span class="line">        nn.BatchNorm2d(oup),  <span class="comment"># 批归一化层</span></span><br><span class="line">        nn.ReLU6(inplace=<span class="literal">True</span>)  <span class="comment"># ReLU激活函数，inplace=True表示原地操作，节省内存</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">conv_1x1_bn</span>(<span class="params">inp, oup</span>):</span><br><span class="line">    <span class="keyword">return</span> nn.Sequential(</span><br><span class="line">        nn.Conv2d(inp, oup, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, bias=<span class="literal">False</span>),  <span class="comment"># 1x1卷积层，步幅为1，填充为0，无偏置</span></span><br><span class="line">        nn.BatchNorm2d(oup),  <span class="comment"># 批归一化层</span></span><br><span class="line">        nn.ReLU6(inplace=<span class="literal">True</span>)  <span class="comment"># ReLU激活函数，inplace=True表示原地操作，节省内存</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保输入值是某个数的倍数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_divisible</span>(<span class="params">x, divisible_by=<span class="number">8</span></span>):</span><br><span class="line">    <span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(np.ceil(x * <span class="number">1.</span> / divisible_by) * divisible_by)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InvertedResidual</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, inp, oup, stride, expand_ratio</span>):</span><br><span class="line">        <span class="built_in">super</span>(InvertedResidual, self).__init__()</span><br><span class="line">        self.stride = stride</span><br><span class="line">        <span class="keyword">assert</span> stride <span class="keyword">in</span> [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">        hidden_dim = <span class="built_in">int</span>(inp * expand_ratio)</span><br><span class="line">        self.use_res_connect = self.stride == <span class="number">1</span> <span class="keyword">and</span> inp == oup</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> expand_ratio == <span class="number">1</span>:</span><br><span class="line">            self.conv = nn.Sequential(</span><br><span class="line">                <span class="comment"># dw</span></span><br><span class="line">                nn.Conv2d(hidden_dim, hidden_dim, <span class="number">3</span>, stride, <span class="number">1</span>, groups=hidden_dim, bias=<span class="literal">False</span>),  <span class="comment"># 深度可分离卷积，dw部分</span></span><br><span class="line">                nn.BatchNorm2d(hidden_dim),  <span class="comment"># 批归一化层</span></span><br><span class="line">                nn.ReLU6(inplace=<span class="literal">True</span>),  <span class="comment"># ReLU激活函数，inplace=True表示原地操作，节省内存</span></span><br><span class="line">                <span class="comment"># pw-linear</span></span><br><span class="line">                nn.Conv2d(hidden_dim, oup, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, bias=<span class="literal">False</span>),  <span class="comment"># 1x1卷积层，线性部分</span></span><br><span class="line">                nn.BatchNorm2d(oup),  <span class="comment"># 批归一化层</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.conv = nn.Sequential(</span><br><span class="line">                <span class="comment"># pw</span></span><br><span class="line">                nn.Conv2d(inp, hidden_dim, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, bias=<span class="literal">False</span>),  <span class="comment"># 1x1卷积层，线性部分</span></span><br><span class="line">                nn.BatchNorm2d(hidden_dim),  <span class="comment"># 批归一化层</span></span><br><span class="line">                nn.ReLU6(inplace=<span class="literal">True</span>),  <span class="comment"># ReLU激活函数，inplace=True表示原地操作，节省内存</span></span><br><span class="line">                <span class="comment"># dw</span></span><br><span class="line">                nn.Conv2d(hidden_dim, hidden_dim, <span class="number">3</span>, stride, <span class="number">1</span>, groups=hidden_dim, bias=<span class="literal">False</span>),  <span class="comment"># 深度可分离卷积，dw部分</span></span><br><span class="line">                nn.BatchNorm2d(hidden_dim),  <span class="comment"># 批归一化层</span></span><br><span class="line">                nn.ReLU6(inplace=<span class="literal">True</span>),  <span class="comment"># ReLU激活函数，inplace=True表示原地操作，节省内存</span></span><br><span class="line">                <span class="comment"># pw-linear</span></span><br><span class="line">                nn.Conv2d(hidden_dim, oup, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, bias=<span class="literal">False</span>),  <span class="comment"># 1x1卷积层，线性部分</span></span><br><span class="line">                nn.BatchNorm2d(oup),  <span class="comment"># 批归一化层</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="keyword">if</span> self.use_res_connect:</span><br><span class="line">            <span class="keyword">return</span> x + self.conv(x)  <span class="comment"># 如果使用残差连接，直接相加</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.conv(x)  <span class="comment"># 否则，执行卷积块中定义的操作</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MobileNetV2</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, n_class=<span class="number">1000</span>, input_size=<span class="number">224</span>, width_mult=<span class="number">1.</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(MobileNetV2, self).__init__()</span><br><span class="line">        block = InvertedResidual</span><br><span class="line">        input_channel = <span class="number">32</span></span><br><span class="line">        last_channel = <span class="number">1280</span></span><br><span class="line">        interverted_residual_setting = [</span><br><span class="line">            <span class="comment"># t, c, n, s</span></span><br><span class="line">            [<span class="number">1</span>, <span class="number">16</span>, <span class="number">1</span>, <span class="number">1</span>],</span><br><span class="line">            [<span class="number">6</span>, <span class="number">24</span>, <span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">            [<span class="number">6</span>, <span class="number">32</span>, <span class="number">3</span>, <span class="number">2</span>],</span><br><span class="line">            [<span class="number">6</span>, <span class="number">64</span>, <span class="number">4</span>, <span class="number">2</span>],</span><br><span class="line">            [<span class="number">6</span>, <span class="number">96</span>, <span class="number">3</span>, <span class="number">1</span>],</span><br><span class="line">            [<span class="number">6</span>, <span class="number">160</span>, <span class="number">3</span>, <span class="number">2</span>],</span><br><span class="line">            [<span class="number">6</span>, <span class="number">320</span>, <span class="number">1</span>, <span class="number">1</span>],</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># building first layer</span></span><br><span class="line">        <span class="keyword">assert</span> input_size % <span class="number">32</span> == <span class="number">0</span></span><br><span class="line">        <span class="comment"># input_channel = make_divisible(input_channel * width_mult)  # first channel is always 32!</span></span><br><span class="line">        self.last_channel = make_divisible(last_channel * width_mult) <span class="keyword">if</span> width_mult &gt; <span class="number">1.0</span> <span class="keyword">else</span> last_channel</span><br><span class="line">        self.features = [conv_bn(<span class="number">3</span>, input_channel, <span class="number">2</span>)]  <span class="comment"># 第一层卷积块，3通道输入，32通道输出，步幅为2</span></span><br><span class="line">        <span class="comment"># building inverted residual blocks</span></span><br><span class="line">        <span class="keyword">for</span> t, c, n, s <span class="keyword">in</span> interverted_residual_setting:</span><br><span class="line">            output_channel = make_divisible(c * width_mult) <span class="keyword">if</span> t &gt; <span class="number">1</span> <span class="keyword">else</span> c</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">                <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                    self.features.append(block(input_channel, output_channel, s, expand_ratio=t))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.features.append(block(input_channel, output_channel, <span class="number">1</span>, expand_ratio=t))</span><br><span class="line">                input_channel = output_channel</span><br><span class="line">        <span class="comment"># building last several layers</span></span><br><span class="line">        self.features.append(conv_1x1_bn(input_channel, self.last_channel))</span><br><span class="line">        <span class="comment"># make it nn.Sequential</span></span><br><span class="line">        self.features = nn.Sequential(*self.features)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># building classifier</span></span><br><span class="line">        self.classifier = nn.Linear(self.last_channel, n_class)</span><br><span class="line"></span><br><span class="line">        self._initialize_weights()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = self.features(x)</span><br><span class="line">        x = x.mean(<span class="number">3</span>).mean(<span class="number">2</span>)  <span class="comment"># 全局平均池化</span></span><br><span class="line">        x = self.classifier(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_initialize_weights</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, nn.Conv2d):</span><br><span class="line">                n = m.kernel_size[<span class="number">0</span>] * m.kernel_size[<span class="number">1</span>] * m.out_channels</span><br><span class="line">                m.weight.data.normal_(<span class="number">0</span>, math.sqrt(<span class="number">2.</span> / n))</span><br><span class="line">                <span class="keyword">if</span> m.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    m.bias.data.zero_()</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, nn.BatchNorm2d):</span><br><span class="line">                m.weight.data.fill_(<span class="number">1</span>)</span><br><span class="line">                m.bias.data.zero_()</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, nn.Linear):</span><br><span class="line">                n = m.weight.size(<span class="number">1</span>)</span><br><span class="line">                m.weight.data.normal_(<span class="number">0</span>, <span class="number">0.01</span>)</span><br><span class="line">                m.bias.data.zero_()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建MobileNetV2模型的实例，并加载预训练权重</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mobilenet_v2</span>(<span class="params">pretrained=<span class="literal">True</span></span>):</span><br><span class="line">    model = MobileNetV2(width_mult=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">from</span> torch.hub <span class="keyword">import</span> load_state_dict_from_url</span><br><span class="line">        <span class="keyword">except</span> ImportError:</span><br><span class="line">            <span class="keyword">from</span> torch.utils.model_zoo <span class="keyword">import</span> load_url <span class="keyword">as</span> load_state_dict_from_url</span><br><span class="line">        state_dict = load_state_dict_from_url(</span><br><span class="line">            <span class="string">r&quot;C:\Users\86176\.cache\torch\hub\checkpoints\mobilenetv2_1.0-f2a8633.pth.tar&quot;</span>, progress=<span class="literal">True</span>)</span><br><span class="line">        model.load_state_dict(state_dict)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在主程序中创建MobileNetV2模型的实例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    net = mobilenet_v2(<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="校验单个图片的特征向量提取"><a href="#校验单个图片的特征向量提取" class="headerlink" title="校验单个图片的特征向量提取"></a>校验单个图片的特征向量提取</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">from</span> MobileNetV2 <span class="keyword">import</span> mobilenet_v2</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...（之前的 MobileNetV2 模型定义代码）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建MobileNetV2模型的实例，并加载预训练权重</span></span><br><span class="line">net = mobilenet_v2(<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 载入图像并进行预处理</span></span><br><span class="line">image_path = <span class="string">r&quot;C:\Users\86176\Desktop\dog.jpg&quot;</span></span><br><span class="line">input_image = Image.<span class="built_in">open</span>(image_path).convert(<span class="string">&quot;RGB&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用与训练时相同的图像预处理步骤</span></span><br><span class="line">preprocess = transforms.Compose([</span><br><span class="line">    transforms.Resize(<span class="number">256</span>),</span><br><span class="line">    transforms.CenterCrop(<span class="number">224</span>),</span><br><span class="line">    transforms.ToTensor(),</span><br><span class="line">    transforms.Normalize(mean=[<span class="number">0.485</span>, <span class="number">0.456</span>, <span class="number">0.406</span>], std=[<span class="number">0.229</span>, <span class="number">0.224</span>, <span class="number">0.225</span>]),</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">input_tensor = preprocess(input_image)</span><br><span class="line">input_batch = input_tensor.unsqueeze(<span class="number">0</span>)  <span class="comment"># 添加批次维度</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 将输入传递给模型进行推理</span></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    output = net(input_batch)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 输出特征</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Output features:&quot;</span>, output)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="三元组损失函数计算部分："><a href="#三元组损失函数计算部分：" class="headerlink" title="三元组损失函数计算部分："></a>三元组损失函数计算部分：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#从数据集中进行抽样图片，参数为训练数据集，每一个batch抽样多少人，每个人抽样多少张</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sample_people</span>(<span class="params">dataset, people_per_batch, images_per_person</span>):</span><br><span class="line">    <span class="comment">#总共应该抽样多少张 默认：people_per_batch：45  images_per_person：40</span></span><br><span class="line">    nrof_images = people_per_batch * images_per_person</span><br><span class="line">  </span><br><span class="line">    <span class="comment">#数据集中一共有多少人的图像</span></span><br><span class="line">    nrof_classes = <span class="built_in">len</span>(dataset)</span><br><span class="line">    <span class="comment">#每个人的索引</span></span><br><span class="line">    class_indices = np.arange(nrof_classes)</span><br><span class="line">    <span class="comment">#随机打乱一下</span></span><br><span class="line">    np.random.shuffle(class_indices)</span><br><span class="line">    </span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="comment">#保存抽样出来的图像的路径</span></span><br><span class="line">    image_paths = []</span><br><span class="line">    <span class="comment">#抽样的样本是属于哪一个人的，作为label</span></span><br><span class="line">    num_per_class = []</span><br><span class="line">    sampled_class_indices = []</span><br><span class="line">    <span class="comment"># Sample images from these classes until we have enough</span></span><br><span class="line">    <span class="comment"># 不断抽样直到达到指定数量</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(image_paths)&lt;nrof_images:</span><br><span class="line">        <span class="comment">#从第i个人开始抽样</span></span><br><span class="line">        class_index = class_indices[i]</span><br><span class="line">        <span class="comment">#第i个人有多少张图片</span></span><br><span class="line">        nrof_images_in_class = <span class="built_in">len</span>(dataset[class_index])</span><br><span class="line">        <span class="comment">#这些图片的索引</span></span><br><span class="line">        image_indices = np.arange(nrof_images_in_class)</span><br><span class="line">        np.random.shuffle(image_indices)</span><br><span class="line">        <span class="comment">#从第i个人中抽样的图片数量</span></span><br><span class="line">        nrof_images_from_class = <span class="built_in">min</span>(nrof_images_in_class, images_per_person, nrof_images-<span class="built_in">len</span>(image_paths))</span><br><span class="line">        idx = image_indices[<span class="number">0</span>:nrof_images_from_class]</span><br><span class="line">        <span class="comment">#抽样出来的人的路径</span></span><br><span class="line">        image_paths_for_class = [dataset[class_index].image_paths[j] <span class="keyword">for</span> j <span class="keyword">in</span> idx]</span><br><span class="line">        <span class="comment">#图片的label</span></span><br><span class="line">        sampled_class_indices += [class_index]*nrof_images_from_class</span><br><span class="line">        image_paths += image_paths_for_class</span><br><span class="line">        <span class="comment">#第i个人抽样了多少张</span></span><br><span class="line">        num_per_class.append(nrof_images_from_class)</span><br><span class="line">        i+=<span class="number">1</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> image_paths, num_per_class</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_triplets</span>(<span class="params">embeddings, nrof_images_per_class, image_paths, people_per_batch, alpha</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; Select the triplets for training</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    trip_idx = <span class="number">0</span></span><br><span class="line">    <span class="comment">#某个人的图片的embedding在emb_arr中的开始的索引</span></span><br><span class="line">    emb_start_idx = <span class="number">0</span></span><br><span class="line">    num_trips = <span class="number">0</span></span><br><span class="line">    triplets = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#遍历每一个人</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(people_per_batch):</span><br><span class="line">        <span class="comment">#这个人有多少张图片</span></span><br><span class="line">        nrof_images = <span class="built_in">int</span>(nrof_images_per_class[i])</span><br><span class="line">        <span class="comment">#遍历第i个人的所有图片</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,nrof_images):</span><br><span class="line">            <span class="comment">#第j张图的embedding在emb_arr 中的位置</span></span><br><span class="line">            a_idx = emb_start_idx + j - <span class="number">1</span></span><br><span class="line">            <span class="comment">#第j张图跟其他所有图片的欧氏距离</span></span><br><span class="line">            neg_dists_sqr = np.<span class="built_in">sum</span>(np.square(embeddings[a_idx] - embeddings), <span class="number">1</span>)</span><br><span class="line">            <span class="comment">#遍历每一对可能的(anchor,postive)图片，记为(a,p)吧</span></span><br><span class="line">            <span class="keyword">for</span> pair <span class="keyword">in</span> <span class="built_in">range</span>(j, nrof_images): <span class="comment"># For every possible positive pair.</span></span><br><span class="line">                <span class="comment">#第p张图片在emb_arr中的位置</span></span><br><span class="line">                p_idx = emb_start_idx + pair</span><br><span class="line">                <span class="comment">#(a,p)之前的欧式距离</span></span><br><span class="line">                pos_dist_sqr = np.<span class="built_in">sum</span>(np.square(embeddings[a_idx]-embeddings[p_idx]))</span><br><span class="line">                <span class="comment">#同一个人的图片不作为negative，所以将距离设为无穷大</span></span><br><span class="line">                neg_dists_sqr[emb_start_idx:emb_start_idx+nrof_images] = np.NaN</span><br><span class="line">                <span class="comment">#all_neg = np.where(np.logical_and(neg_dists_sqr-pos_dist_sqr&lt;alpha, pos_dist_sqr&lt;neg_dists_sqr))[0]  # FaceNet selection</span></span><br><span class="line">                <span class="comment">#其他人的图片中有哪些图片与a之间的距离-p与a之间的距离小于alpha的</span></span><br><span class="line">                all_neg = np.where(neg_dists_sqr-pos_dist_sqr&lt;alpha)[<span class="number">0</span>] <span class="comment"># VGG Face selecction</span></span><br><span class="line">                <span class="comment">#所有可能的negative</span></span><br><span class="line">                nrof_random_negs = all_neg.shape[<span class="number">0</span>]</span><br><span class="line">                <span class="comment">#如果有满足条件的negative</span></span><br><span class="line">                <span class="keyword">if</span> nrof_random_negs&gt;<span class="number">0</span>:</span><br><span class="line">                    <span class="comment">#从中随机选取一个作为n</span></span><br><span class="line">                    rnd_idx = np.random.randint(nrof_random_negs)</span><br><span class="line">                    n_idx = all_neg[rnd_idx]</span><br><span class="line">                    <span class="comment"># 选到(a,p,n)作为三元组</span></span><br><span class="line">                    triplets.append((image_paths[a_idx], image_paths[p_idx], image_paths[n_idx]))</span><br><span class="line">                    <span class="comment">#print(&#x27;Triplet %d: (%d, %d, %d), pos_dist=%2.6f, neg_dist=%2.6f (%d, %d, %d, %d, %d)&#x27; % </span></span><br><span class="line">                    <span class="comment">#    (trip_idx, a_idx, p_idx, n_idx, pos_dist_sqr, neg_dists_sqr[n_idx], nrof_random_negs, rnd_idx, i, j, emb_start_idx))</span></span><br><span class="line">                    trip_idx += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                num_trips += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        emb_start_idx += nrof_images</span><br><span class="line"></span><br><span class="line">    np.random.shuffle(triplets)</span><br><span class="line">    <span class="keyword">return</span> triplets, num_trips, <span class="built_in">len</span>(triplets)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这段代码中，<code>select_triplets</code> 函数生成用于训练的三元组（triplets），其中每个三元组包含一个锚点图像、一个正样本图像和一个负样本图像。这种三元组的生成方式通常用于训练人脸验证或识别模型，以强调模型对于同一人的图像更加相似，而对于不同人的图像更加不同。</p>
<p>为了将 <code>select_triplets</code> 函数与 MobileNetV2 模型结合起来，可以按照以下步骤进行：</p>
<ol>
<li>使用 <code>mobilenet_v2</code> 函数创建 MobileNetV2 模型的实例：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model = mobilenet_v2(pretrained=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将 MobileNetV2 模型的嵌入（embeddings）作为输入传递给 <code>select_triplets</code> 函数，同时传递其他必要的参数：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 假设 embeddings 是通过模型前向传播得到的嵌入向量</span></span><br><span class="line">embeddings = model(some_input_data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成三元组</span></span><br><span class="line">triplets, num_trips, actual_num_trips = select_triplets(embeddings, nrof_images_per_class, image_paths, people_per_batch, alpha)</span><br></pre></td></tr></table></figure>

<p>这样，就可以使用 MobileNetV2 模型生成嵌入向量，并将这些嵌入向量传递给 <code>select_triplets</code> 函数，以获得用于训练的三元组。这种训练方法旨在通过学习嵌入向量的特征表示来提高模型对于同一人的图像相似性，同时将不同人的图像差异性最大化。</p>
<h2 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h2><p>根据pytorch官方给出的指引代码，完成对现成已有的mobilenetV2模型的调用，完成图片的输入和输出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="comment"># torch.hub.load是PyTorch库中用于从GitHub仓库加载模型、数据等资源的函数。</span></span><br><span class="line"><span class="comment"># 模型的权重会被下载并保存在系统的临时目录中</span></span><br><span class="line">model = torch.hub.load(<span class="string">&#x27;pytorch/vision:v0.10.0&#x27;</span>, <span class="string">&#x27;mobilenet_v2&#x27;</span>, pretrained=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 将加载的模型切换到评估（inference）模式,禁用一些训练时使用的特定层</span></span><br><span class="line">model.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="comment"># 用于通过URL下载文件并保存到本地</span></span><br><span class="line">url, filename = (<span class="string">r&quot;C:\Users\86176\Desktop\dog.jpg&quot;</span>, <span class="string">r&quot;C:\Users\86176\Desktop\dog.jpg&quot;</span>)</span><br><span class="line"><span class="comment"># 使用本地</span></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"><span class="comment">#     urllib.request.urlretrieve(url, filename)</span></span><br><span class="line"><span class="comment"># except urllib.error.URLError as e:</span></span><br><span class="line"><span class="comment">#     print(f&quot;Error: &#123;e&#125;&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 PyTorch 和 torchvision 对一个图像进行预处理，并使用预训练的 MobileNetV2 模型进行推理</span></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms</span><br><span class="line"><span class="comment"># 打开一个图像文件</span></span><br><span class="line">input_image = Image.<span class="built_in">open</span>(filename)</span><br><span class="line"><span class="comment"># 创建了一个图像预处理的管道，其中包括将图像大小调整为 256x256 像素，然后在中心裁剪为 224x224 像素。</span></span><br><span class="line"><span class="comment"># transforms.ToTensor() 将图像转换为 PyTorch 的张量。</span></span><br><span class="line"><span class="comment"># transforms.Normalize 对张量进行标准化，使用指定的均值和标准差。这是为了使输入符合 MobileNetV2 模型预训练时的标准。</span></span><br><span class="line">preprocess = transforms.Compose([</span><br><span class="line">    transforms.Resize(<span class="number">256</span>),</span><br><span class="line">    transforms.CenterCrop(<span class="number">224</span>),</span><br><span class="line">    <span class="comment"># 将图像转换为 PyTorch 的张量</span></span><br><span class="line">    transforms.ToTensor(),</span><br><span class="line">    <span class="comment"># 对张量进行标准化</span></span><br><span class="line">    transforms.Normalize(mean=[<span class="number">0.485</span>, <span class="number">0.456</span>, <span class="number">0.406</span>], std=[<span class="number">0.229</span>, <span class="number">0.224</span>, <span class="number">0.225</span>]),</span><br><span class="line">])</span><br><span class="line">input_tensor = preprocess(input_image)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加一个维度，以创建一个 mini-batch</span></span><br><span class="line">input_batch = input_tensor.unsqueeze(<span class="number">0</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment"># move the input and model to GPU for speed if available</span></span><br><span class="line"><span class="comment"># 移动输入和模型到 GPU（如果可用）</span></span><br><span class="line"><span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">    input_batch = input_batch.to(<span class="string">&#x27;cuda&#x27;</span>)</span><br><span class="line">    model.to(<span class="string">&#x27;cuda&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保在推理时不进行梯度计算，因为这里只是对模型进行前向传播而不是训练</span></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    output = model(input_batch)</span><br><span class="line"><span class="comment"># Tensor of shape 1000, with confidence scores over ImageNet&#x27;s 1000 classes</span></span><br><span class="line"><span class="built_in">print</span>(output[<span class="number">0</span>])</span><br><span class="line"><span class="comment"># The output has unnormalized scores. To get probabilities, you can run a softmax on it.</span></span><br><span class="line"><span class="comment"># 处理输出结果</span></span><br><span class="line"><span class="comment"># 使用 softmax 函数将模型输出的分数转换为概率，以便更容易理解预测结果。</span></span><br><span class="line"><span class="comment"># softmax 操作将原始分数转换为概率，使得所有类别的概率之和为 1</span></span><br><span class="line">probabilities = torch.nn.functional.softmax(output[<span class="number">0</span>], dim=<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(probabilities)</span><br></pre></td></tr></table></figure>





<h1 id="mobilefacenet"><a href="#mobilefacenet" class="headerlink" title="mobilefacenet"></a>mobilefacenet</h1><h2 id="定义MobileFaceNet模型"><a href="#定义MobileFaceNet模型" class="headerlink" title="定义MobileFaceNet模型:"></a>定义MobileFaceNet模型:</h2><p>包含了一系列的卷积块（ConvBlock）、线性块（LinearBlock）、深度卷积块（DepthWise）、深度卷积残差块（DepthWiseResidual）、残差块（Residual）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> Linear, Conv2d, BatchNorm1d, BatchNorm2d, PReLU, Sequential, Module, Flatten</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConvBlock</span>(<span class="title class_ inherited__">Module</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_c, out_c, kernel=(<span class="params"><span class="number">1</span>, <span class="number">1</span></span>), stride=(<span class="params"><span class="number">1</span>, <span class="number">1</span></span>), padding=(<span class="params"><span class="number">0</span>, <span class="number">0</span></span>), groups=<span class="number">1</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(ConvBlock, self).__init__()</span><br><span class="line">        self.conv = Conv2d(in_c, out_channels=out_c, kernel_size=kernel, groups=groups, stride=stride, padding=padding,</span><br><span class="line">                           bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn = BatchNorm2d(out_c)</span><br><span class="line">        self.prelu = PReLU(out_c)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = self.conv(x)</span><br><span class="line">        x = self.bn(x)</span><br><span class="line">        x = self.prelu(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LinearBlock</span>(<span class="title class_ inherited__">Module</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_c, out_c, kernel=(<span class="params"><span class="number">1</span>, <span class="number">1</span></span>), stride=(<span class="params"><span class="number">1</span>, <span class="number">1</span></span>), padding=(<span class="params"><span class="number">0</span>, <span class="number">0</span></span>), groups=<span class="number">1</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(LinearBlock, self).__init__()</span><br><span class="line">        self.conv = Conv2d(in_c, out_channels=out_c, kernel_size=kernel, groups=groups, stride=stride, padding=padding,</span><br><span class="line">                           bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn = BatchNorm2d(out_c)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = self.conv(x)</span><br><span class="line">        x = self.bn(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DepthWise</span>(<span class="title class_ inherited__">Module</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_c, out_c, kernel=(<span class="params"><span class="number">3</span>, <span class="number">3</span></span>), stride=(<span class="params"><span class="number">2</span>, <span class="number">2</span></span>), padding=(<span class="params"><span class="number">1</span>, <span class="number">1</span></span>), groups=<span class="number">1</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(DepthWise, self).__init__()</span><br><span class="line">        self.conv = ConvBlock(in_c, out_c=groups, kernel=(<span class="number">1</span>, <span class="number">1</span>), padding=(<span class="number">0</span>, <span class="number">0</span>), stride=(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">        self.conv_dw = ConvBlock(groups, groups, groups=groups, kernel=kernel, padding=padding, stride=stride)</span><br><span class="line">        self.project = LinearBlock(groups, out_c, kernel=(<span class="number">1</span>, <span class="number">1</span>), padding=(<span class="number">0</span>, <span class="number">0</span>), stride=(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = self.conv(x)</span><br><span class="line">        x = self.conv_dw(x)</span><br><span class="line">        x = self.project(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DepthWiseResidual</span>(<span class="title class_ inherited__">Module</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_c, out_c, kernel=(<span class="params"><span class="number">3</span>, <span class="number">3</span></span>), stride=(<span class="params"><span class="number">2</span>, <span class="number">2</span></span>), padding=(<span class="params"><span class="number">1</span>, <span class="number">1</span></span>), groups=<span class="number">1</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(DepthWiseResidual, self).__init__()</span><br><span class="line">        self.conv = ConvBlock(in_c, out_c=groups, kernel=(<span class="number">1</span>, <span class="number">1</span>), padding=(<span class="number">0</span>, <span class="number">0</span>), stride=(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">        self.conv_dw = ConvBlock(groups, groups, groups=groups, kernel=kernel, padding=padding, stride=stride)</span><br><span class="line">        self.project = LinearBlock(groups, out_c, kernel=(<span class="number">1</span>, <span class="number">1</span>), padding=(<span class="number">0</span>, <span class="number">0</span>), stride=(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        short_cut = x</span><br><span class="line">        x = self.conv(x)</span><br><span class="line">        x = self.conv_dw(x)</span><br><span class="line">        x = self.project(x)</span><br><span class="line">        output = short_cut + x</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Residual</span>(<span class="title class_ inherited__">Module</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, c, num_block, groups, kernel=(<span class="params"><span class="number">3</span>, <span class="number">3</span></span>), stride=(<span class="params"><span class="number">1</span>, <span class="number">1</span></span>), padding=(<span class="params"><span class="number">1</span>, <span class="number">1</span></span>)</span>):</span><br><span class="line">        <span class="built_in">super</span>(Residual, self).__init__()</span><br><span class="line">        modules = []</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_block):</span><br><span class="line">            modules.append(</span><br><span class="line">                DepthWiseResidual(c, c, kernel=kernel, padding=padding, stride=stride, groups=groups))</span><br><span class="line">        self.model = Sequential(*modules)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="keyword">return</span> self.model(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MobileFaceNet</span>(<span class="title class_ inherited__">Module</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(MobileFaceNet, self).__init__()</span><br><span class="line">        self.conv1 = ConvBlock(<span class="number">3</span>, <span class="number">64</span>, kernel=(<span class="number">3</span>, <span class="number">3</span>), stride=(<span class="number">2</span>, <span class="number">2</span>), padding=(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">        self.conv2_dw = ConvBlock(<span class="number">64</span>, <span class="number">64</span>, kernel=(<span class="number">3</span>, <span class="number">3</span>), stride=(<span class="number">1</span>, <span class="number">1</span>), padding=(<span class="number">1</span>, <span class="number">1</span>), groups=<span class="number">64</span>)</span><br><span class="line">        self.conv_23 = DepthWise(<span class="number">64</span>, <span class="number">64</span>, kernel=(<span class="number">3</span>, <span class="number">3</span>), stride=(<span class="number">2</span>, <span class="number">2</span>), padding=(<span class="number">1</span>, <span class="number">1</span>), groups=<span class="number">128</span>)</span><br><span class="line">        self.conv_3 = Residual(<span class="number">64</span>, num_block=<span class="number">4</span>, groups=<span class="number">128</span>, kernel=(<span class="number">3</span>, <span class="number">3</span>), stride=(<span class="number">1</span>, <span class="number">1</span>), padding=(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">        self.conv_34 = DepthWise(<span class="number">64</span>, <span class="number">128</span>, kernel=(<span class="number">3</span>, <span class="number">3</span>), stride=(<span class="number">2</span>, <span class="number">2</span>), padding=(<span class="number">1</span>, <span class="number">1</span>), groups=<span class="number">256</span>)</span><br><span class="line">        self.conv_4 = Residual(<span class="number">128</span>, num_block=<span class="number">6</span>, groups=<span class="number">256</span>, kernel=(<span class="number">3</span>, <span class="number">3</span>), stride=(<span class="number">1</span>, <span class="number">1</span>), padding=(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">        self.conv_45 = DepthWise(<span class="number">128</span>, <span class="number">128</span>, kernel=(<span class="number">3</span>, <span class="number">3</span>), stride=(<span class="number">2</span>, <span class="number">2</span>), padding=(<span class="number">1</span>, <span class="number">1</span>), groups=<span class="number">512</span>)</span><br><span class="line">        self.conv_5 = Residual(<span class="number">128</span>, num_block=<span class="number">2</span>, groups=<span class="number">256</span>, kernel=(<span class="number">3</span>, <span class="number">3</span>), stride=(<span class="number">1</span>, <span class="number">1</span>), padding=(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">        self.conv_6_sep = ConvBlock(<span class="number">128</span>, <span class="number">512</span>, kernel=(<span class="number">1</span>, <span class="number">1</span>), stride=(<span class="number">1</span>, <span class="number">1</span>), padding=(<span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">        self.conv_6_dw = LinearBlock(<span class="number">512</span>, <span class="number">512</span>, groups=<span class="number">512</span>, kernel=(<span class="number">7</span>, <span class="number">7</span>), stride=(<span class="number">1</span>, <span class="number">1</span>), padding=(<span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">        self.flatten = Flatten()</span><br><span class="line">        self.linear = Linear(<span class="number">512</span>, <span class="number">512</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn = BatchNorm1d(<span class="number">512</span>)</span><br><span class="line">        <span class="comment"># self.fc = Linear(512,10575)</span></span><br><span class="line">        <span class="comment"># self.bn_1 = BatchNorm1d(10575)</span></span><br><span class="line">        <span class="comment"># self.fc = Linear(512,10575)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = self.conv1(x)</span><br><span class="line">        x = self.conv2_dw(x)</span><br><span class="line">        x = self.conv_23(x)</span><br><span class="line">        x = self.conv_3(x)</span><br><span class="line">        x = self.conv_34(x)</span><br><span class="line">        x = self.conv_4(x)</span><br><span class="line">        x = self.conv_45(x)</span><br><span class="line">        x = self.conv_5(x)</span><br><span class="line">        x = self.conv_6_sep(x)</span><br><span class="line">        x = self.conv_6_dw(x)</span><br><span class="line">        x = self.flatten(x)</span><br><span class="line">        x = self.linear(x)</span><br><span class="line">        x = self.bn(x)</span><br><span class="line">        <span class="comment"># cls = self.fc(x)</span></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def forward_2(self,x):</span></span><br><span class="line">    <span class="comment">#     x = MobileFaceNet.forward()</span></span><br><span class="line">    <span class="comment">#     x = self.fc(x)</span></span><br><span class="line">    <span class="comment">#     x = self.bn_1(x)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>整体架构是基于轻量级设计的MobileNet风格，通过深度可分离卷积、残差连接等技术，在保持准确性的同时减小了模型的参数量和计算复杂度，适用于移动端或嵌入式设备的人脸识别任务。</p>
<h2 id="arcface"><a href="#arcface" class="headerlink" title="arcface"></a>arcface</h2><p>损失函数使用arcface</p>
<p>一些重要的参数，如<code>feature_dim</code>（特征维度）、<code>class_dim</code>（类别数）、<code>margin</code>（margin参数）、<code>scale</code>（scale参数）</p>
<p>在前向传播函数中，对输入特征向量进行了归一化，并计算了余弦相似度。然后，根据ArcFace的损失函数公式，计算了角度余弦值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> Parameter</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArcNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,</span></span><br><span class="line"><span class="params">                 feature_dim,</span></span><br><span class="line"><span class="params">                 class_dim,</span></span><br><span class="line"><span class="params">                 margin=<span class="number">0.2</span>,</span></span><br><span class="line"><span class="params">                 scale=<span class="number">30.0</span>,</span></span><br><span class="line"><span class="params">                 easy_margin=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.feature_dim = feature_dim</span><br><span class="line">        self.class_dim = class_dim</span><br><span class="line">        self.margin = margin</span><br><span class="line">        self.scale = scale</span><br><span class="line">        self.easy_margin = easy_margin</span><br><span class="line">        self.weight = Parameter(torch.FloatTensor(feature_dim, class_dim))</span><br><span class="line">        nn.init.xavier_uniform_(self.weight)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, <span class="built_in">input</span>, label</span>):</span><br><span class="line">        input_norm = torch.sqrt(torch.<span class="built_in">sum</span>(torch.square(<span class="built_in">input</span>), dim=<span class="number">1</span>, keepdim=<span class="literal">True</span>))</span><br><span class="line">        <span class="built_in">input</span> = torch.divide(<span class="built_in">input</span>, input_norm)</span><br><span class="line"></span><br><span class="line">        weight_norm = torch.sqrt(torch.<span class="built_in">sum</span>(torch.square(self.weight), dim=<span class="number">0</span>, keepdim=<span class="literal">True</span>))</span><br><span class="line">        weight = torch.divide(self.weight, weight_norm)</span><br><span class="line"></span><br><span class="line">        cos = torch.matmul(<span class="built_in">input</span>, weight)</span><br><span class="line">        sin = torch.sqrt(<span class="number">1.0</span> - torch.square(cos) + <span class="number">1e-6</span>)</span><br><span class="line">        cos_m = math.cos(self.margin)</span><br><span class="line">        sin_m = math.sin(self.margin)</span><br><span class="line">        phi = cos * cos_m - sin * sin_m</span><br><span class="line"></span><br><span class="line">        th = math.cos(self.margin) * (-<span class="number">1</span>)</span><br><span class="line">        mm = math.sin(self.margin) * self.margin</span><br><span class="line">        <span class="keyword">if</span> self.easy_margin:</span><br><span class="line">            phi = self._paddle_where_more_than(cos, <span class="number">0</span>, phi, cos)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            phi = self._paddle_where_more_than(cos, th, phi, cos - mm)</span><br><span class="line">        one_hot = torch.nn.functional.one_hot(label, self.class_dim)</span><br><span class="line">        one_hot = torch.squeeze(one_hot, dim=<span class="number">1</span>)</span><br><span class="line">        output = torch.multiply(one_hot, phi) + torch.multiply((<span class="number">1.0</span> - one_hot), cos)</span><br><span class="line">        output = output * self.scale</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_paddle_where_more_than</span>(<span class="params">self, target, limit, x, y</span>):</span><br><span class="line">        mask = (target &gt; limit).<span class="built_in">float</span>()</span><br><span class="line">        output = torch.multiply(mask, x) + torch.multiply((<span class="number">1.0</span> - mask), y)</span><br><span class="line">        <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure>



<h2 id="获取初始图片"><a href="#获取初始图片" class="headerlink" title="获取初始图片"></a>获取初始图片</h2><p>这里利用的是cv2，电脑端对模型的准确结果进行测试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> dlib</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="comment"># 要添加的路径</span></span><br><span class="line">new_path = <span class="string">r&#x27;C:\Users\86176\Desktop\torch-project\Mobilefacenet\face_attendance&#x27;</span></span><br><span class="line"><span class="comment"># 将路径添加到sys.path</span></span><br><span class="line">sys.path.append(new_path)</span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">as</span> FIG</span><br><span class="line"></span><br><span class="line"><span class="comment"># 图片存储位置</span></span><br><span class="line">user_name = FIG.catch_picture_username</span><br><span class="line">output_dir = os.path.join(FIG.catch_picture_path,user_name)</span><br><span class="line">size = FIG.catch_picture_size</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置截取图片的数量</span></span><br><span class="line">index = <span class="number">1</span></span><br><span class="line">picture_num = FIG.catch_picture_num</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置是否改变截图图片亮度</span></span><br><span class="line">islight = FIG.catch_picture_relight</span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断是否有改文件夹</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(output_dir):</span><br><span class="line">    os.makedirs(output_dir)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 改变图片的亮度和对比度</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">relight</span>(<span class="params">img,light=<span class="number">1</span>,bias=<span class="number">0</span></span>):</span><br><span class="line">    w = img.shape[<span class="number">0</span>]</span><br><span class="line">    h = img.shape[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,w):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,h):</span><br><span class="line">            <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):      <span class="comment"># RGB三通道</span></span><br><span class="line">                tmp = <span class="built_in">int</span>(img[i,j,c]*light+bias)</span><br><span class="line">                <span class="keyword">if</span> tmp&gt;<span class="number">255</span>:</span><br><span class="line">                    tmp=<span class="number">255</span></span><br><span class="line">                <span class="keyword">elif</span> tmp &lt;<span class="number">0</span>:</span><br><span class="line">                    tmp = <span class="number">0</span></span><br><span class="line">                img[i,j,c] = tmp</span><br><span class="line">    <span class="keyword">return</span> img</span><br><span class="line"></span><br><span class="line">detector = dlib.get_frontal_face_detector()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开摄像头</span></span><br><span class="line">cap = cv2.VideoCapture(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">if</span>(index&lt;=picture_num):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;正在截取第%s张图片&#x27;</span> %index)</span><br><span class="line">        <span class="comment"># 摄像头读取图片</span></span><br><span class="line">        success , img = cap.read()</span><br><span class="line">        <span class="comment"># 灰度化</span></span><br><span class="line">        gray_img = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)</span><br><span class="line">        <span class="comment"># 调用检测器</span></span><br><span class="line">        dets = detector(gray_img,<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">for</span> i ,d <span class="keyword">in</span>  <span class="built_in">enumerate</span>(dets):</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">type</span>(d))</span><br><span class="line">            x1 = d.top() <span class="keyword">if</span> d.top()&gt;<span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            y1 = d.bottom() <span class="keyword">if</span> d.bottom() <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            x2 = d.left() <span class="keyword">if</span> d.left()&gt;<span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            y2 = d.right() <span class="keyword">if</span> d.right() &gt;<span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 截取脸部图片</span></span><br><span class="line">            face = img[x1:y1,x2:y2]</span><br><span class="line">            <span class="comment"># 调整图片的对比度和亮度</span></span><br><span class="line">            <span class="keyword">if</span> (islight):</span><br><span class="line">                face = relight(face,random.uniform(<span class="number">0.5</span>,<span class="number">1.5</span>),random.randint(-<span class="number">50</span>,<span class="number">50</span>))</span><br><span class="line">            <span class="comment"># 调整图片的大小</span></span><br><span class="line">            face = cv2.resize(face,(size,size))</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">type</span>(face))</span><br><span class="line">            <span class="comment"># 显示图片</span></span><br><span class="line">            cv2.imshow(<span class="string">&#x27;image&#x27;</span>,face)</span><br><span class="line">            <span class="comment"># 保存图片</span></span><br><span class="line">            cv2.imwrite(output_dir+<span class="string">&#x27;/&#x27;</span>+<span class="built_in">str</span>(index)+<span class="string">&#x27;.jpg&#x27;</span>,face)</span><br><span class="line">            <span class="comment"># index 自增</span></span><br><span class="line">            index+=<span class="number">1</span></span><br><span class="line">        key = cv2.waitKey(<span class="number">60</span>)&amp;<span class="number">0xff</span></span><br><span class="line">    <span class="keyword">if</span> index&gt;picture_num:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;已经采集完成&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(output_dir)</span><br><span class="line">        </span><br><span class="line">        cap.release()</span><br><span class="line">        cv2.destroyAllWindows()</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>



<h2 id="特征向量提取"><a href="#特征向量提取" class="headerlink" title="特征向量提取"></a>特征向量提取</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="comment"># 要添加的路径</span></span><br><span class="line">new_path = <span class="string">r&#x27;C:\Users\86176\Desktop\torch-project\Mobilefacenet\face_attendance&#x27;</span></span><br><span class="line"><span class="comment"># 将路径添加到sys.path</span></span><br><span class="line">sys.path.append(new_path)</span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">as</span> FIG</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">from</span> model.mobile_facenet <span class="keyword">import</span> MobileFaceNet</span><br><span class="line"><span class="keyword">from</span> torch.autograd <span class="keyword">import</span> Variable</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">create_feature</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,model_path,img_path,catch_picture_size,model_type,feature_path</span>):</span><br><span class="line">        self.model_path = model_path</span><br><span class="line">        self.img_path = img_path</span><br><span class="line">        self.picture_size = catch_picture_size</span><br><span class="line">        self.model_type = model_type</span><br><span class="line">        self.feature_path = feature_path</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 给图片加上黑边框</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">padding_black</span>(<span class="params">self,img</span>):</span><br><span class="line">        w, h = img.size</span><br><span class="line">        scale = self.picture_size / <span class="built_in">max</span>(w, h)</span><br><span class="line">        img_fg = img.resize([<span class="built_in">int</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> [w * scale, h * scale]])</span><br><span class="line">        size_fg = img_fg.size</span><br><span class="line">        size_bg = picture_size</span><br><span class="line">        img_bg = Image.new(<span class="string">&quot;RGB&quot;</span>, (size_bg, size_bg))</span><br><span class="line">        img_bg.paste(img_fg, ((size_bg - size_fg[<span class="number">0</span>]) // <span class="number">2</span>,</span><br><span class="line">                              (size_bg - size_fg[<span class="number">1</span>]) // <span class="number">2</span>))</span><br><span class="line">        img = img_bg</span><br><span class="line">        <span class="keyword">return</span> img</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 保存特征向量</span></span><br><span class="line">    <span class="comment"># def save_feature(self,featureList,img_name):</span></span><br><span class="line">    <span class="comment">#     for i in range(len(featureList)):</span></span><br><span class="line">    <span class="comment">#         user_name = img_name[i]</span></span><br><span class="line">    <span class="comment">#         print(user_name)</span></span><br><span class="line">    <span class="comment">#         # feature_result.append(str(a) for a in featureList[i][0])</span></span><br><span class="line">    <span class="comment">#         feature_result = (str(a) for a in featureList[i][0])</span></span><br><span class="line">    <span class="comment">#         feature_result = &quot;,&quot;.join(feature_result)</span></span><br><span class="line">    <span class="comment">#         # print(feature_result)</span></span><br><span class="line">    <span class="comment">#         with open(&quot;../feature.txt&quot;, &#x27;a&#x27;) as f:</span></span><br><span class="line">    <span class="comment">#             f.writelines(user_name)</span></span><br><span class="line">    <span class="comment">#             f.writelines(&quot;:&quot;)</span></span><br><span class="line">    <span class="comment">#             # f.writelines(&quot;[&quot;)</span></span><br><span class="line">    <span class="comment">#             f.writelines(feature_result)</span></span><br><span class="line">    <span class="comment">#             f.writelines(&#x27;\n&#x27;)</span></span><br><span class="line">    <span class="comment">#             # f.write(&#x27;\n&#x27;)</span></span><br><span class="line">    <span class="comment">#         # feature_result.clear()</span></span><br><span class="line">    <span class="comment">#     f.close()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_feature_2</span>(<span class="params">self,featureList,img_name</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(featureList)):</span><br><span class="line">            name = img_name[i]</span><br><span class="line">            <span class="built_in">print</span>(name)</span><br><span class="line">            feature = <span class="built_in">str</span>(featureList[i][<span class="number">0</span>])</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(self.feature_path, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.writelines(name)</span><br><span class="line">                f.writelines(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">                f.writelines(feature)</span><br><span class="line">                f.writelines(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        <span class="comment"># f.close()</span></span><br><span class="line">    <span class="comment"># 查找路径下的所有图片</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search_picutre</span>(<span class="params">self,img_path</span>):</span><br><span class="line">        imgList = []</span><br><span class="line">        img_name = []</span><br><span class="line">        dirs = os.listdir(img_path)</span><br><span class="line">        <span class="comment"># print(type(dirs))</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> dirs:</span><br><span class="line">            img_name.append(file)    <span class="comment">#img_name=1.jpg</span></span><br><span class="line">            pic_dir = os.path.join(img_path, file)</span><br><span class="line">            <span class="comment"># print(pic_dir)</span></span><br><span class="line">            a = []</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> os.listdir(pic_dir):</span><br><span class="line">                img_dir = os.path.join(pic_dir, i)</span><br><span class="line">                a.append(img_dir)</span><br><span class="line">            imgList.append(a)</span><br><span class="line">        <span class="keyword">return</span> imgList,img_name</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 主函数</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">feature</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 设置预测设备</span></span><br><span class="line">        device = <span class="string">&#x27;cuda&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Using &#123;&#125; to catch feature&quot;</span>.<span class="built_in">format</span>(device))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 加载模型</span></span><br><span class="line">        <span class="keyword">if</span> (self.model_type == <span class="string">&#x27;mobilefacenet&#x27;</span>):</span><br><span class="line">            model = MobileFaceNet()</span><br><span class="line">            model = model.to(device)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> device == <span class="string">&#x27;cpu&#x27;</span>:</span><br><span class="line">            model.load_state_dict(torch.load(self.model_path,map_location=torch.device(<span class="string">&#x27;cpu&#x27;</span>)))</span><br><span class="line">            <span class="comment"># model = torch.load(self.model_path,False)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            model.load_state_dict(torch.load(self.model_path))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        picture_size = self.picture_size  <span class="comment"># 图片尺寸大小</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#  图片标准化</span></span><br><span class="line">        transform_BZ = transforms.Normalize(</span><br><span class="line">            <span class="comment"># mean=[0.485, 0.456, 0.406],  # 取决于数据集</span></span><br><span class="line">            <span class="comment"># std=[0.229, 0.224, 0.225]</span></span><br><span class="line">            mean=[<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>],  <span class="comment"># 取决于数据集</span></span><br><span class="line">            std=[<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 图片预处理</span></span><br><span class="line">        val_tf = transforms.Compose([transforms.Resize([picture_size, picture_size]),</span><br><span class="line">                                     transforms.ToTensor(),</span><br><span class="line">                                     transform_BZ</span><br><span class="line">                                     ])</span><br><span class="line">        featurelist = []</span><br><span class="line">        Oneperson_feature = []</span><br><span class="line">        <span class="comment"># 加载图片</span></span><br><span class="line">        img_path,img_name = create_feature.search_picutre(self,self.img_path)</span><br><span class="line">        <span class="keyword">for</span> pic_path <span class="keyword">in</span> img_path:</span><br><span class="line">            <span class="keyword">for</span> image_path <span class="keyword">in</span> pic_path:</span><br><span class="line">                img = Image.<span class="built_in">open</span>(image_path)  <span class="comment"># 打开图片</span></span><br><span class="line">                img = img.convert(<span class="string">&#x27;RGB&#x27;</span>)  <span class="comment"># 转换图片格式</span></span><br><span class="line">                image = create_feature.padding_black(self,img)  <span class="comment"># 为图片加上黑边</span></span><br><span class="line">                img_tensor = val_tf(image)   <span class="comment"># 图片预处理</span></span><br><span class="line">                img_tensor = Variable(torch.unsqueeze(img_tensor, dim=<span class="number">0</span>).<span class="built_in">float</span>(), requires_grad=<span class="literal">False</span>).to(device)   <span class="comment"># 增加图片的维度，之前是三维，模型要求四维</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># 进行数据输入和保存特征向量</span></span><br><span class="line">                model.<span class="built_in">eval</span>()</span><br><span class="line">                <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">                    features = model(img_tensor)</span><br><span class="line">                    features = features.detach().cpu().numpy()  <span class="comment"># 将tensor转为ndarray</span></span><br><span class="line">                    Oneperson_feature.append(features)</span><br><span class="line"></span><br><span class="line">            featuremean = np.array(Oneperson_feature).mean(axis=<span class="number">0</span>)</span><br><span class="line">            featurelist.append(featuremean.tolist())</span><br><span class="line">            Oneperson_feature.clear()</span><br><span class="line">        <span class="comment"># print(featurelist[0][0])</span></span><br><span class="line">        create_feature.save_feature_2(self,featurelist,img_name)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;完成了&#123;&#125;个人的特征向量提取&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(featurelist)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    picture_size = FIG.catch_picture_size</span><br><span class="line">    model_type = FIG.model_type</span><br><span class="line">    model_path = FIG.create_feature_model_path_1</span><br><span class="line">    save_feature_path = FIG.save_feature_path</span><br><span class="line">    <span class="comment"># img_path = r&#x27;D:\python\pycharm project\deep_learning\face\face_attendance\data&#x27;</span></span><br><span class="line">    img_path=<span class="string">r&quot;C:\Users\86176\Desktop\torch-project\Mobilefacenet\Fresh pictures&quot;</span></span><br><span class="line">    create_features = create_feature(model_path=model_path,catch_picture_size=picture_size,img_path=img_path,model_type=model_type,</span><br><span class="line">                                     feature_path=save_feature_path)</span><br><span class="line">    create_features.feature()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>查看模型预测结果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> dlib</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">as</span> FIG</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> torch.autograd <span class="keyword">import</span> Variable</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">from</span> model.mobile_facenet <span class="keyword">import</span> MobileFaceNet</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">video</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,model_path,feature_path,picture_size,face_confidence</span>):</span><br><span class="line">        self.model_path = model_path</span><br><span class="line">        self.feature_path = feature_path</span><br><span class="line">        self.picture_size = picture_size</span><br><span class="line">        self.face_confidence = face_confidence</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加载特征向量</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_feature</span>(<span class="params">self</span>):</span><br><span class="line">        name_list = []</span><br><span class="line">        feature_list = []</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(self.feature_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">True</span>):</span><br><span class="line">                a = f.readline()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> a :</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                name,features= a.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">                name_list.append([name])</span><br><span class="line">                feature = features.split(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">                a = feature[<span class="number">0</span>]</span><br><span class="line">                b = ast.literal_eval(a)</span><br><span class="line">                feature_list.append(b)</span><br><span class="line">        <span class="keyword">return</span> name_list,feature_list</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获得视频流图片的特征向量</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getVideoFeature</span>(<span class="params">self,model,image,device</span>):</span><br><span class="line">        <span class="comment">#  图片标准化</span></span><br><span class="line">        transform_BZ = transforms.Normalize(</span><br><span class="line">            mean=[<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>],  <span class="comment"># 取决于数据集</span></span><br><span class="line">            std=[<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>]</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 图片预处理</span></span><br><span class="line">        val_tf = transforms.Compose([transforms.Resize([self.picture_size, self.picture_size]),</span><br><span class="line">                                     transforms.ToTensor(),</span><br><span class="line">                                     transform_BZ</span><br><span class="line">                                     ])</span><br><span class="line">        image = Image.fromarray(image)</span><br><span class="line">        img_tensor = val_tf(image)  <span class="comment"># 图片预处理</span></span><br><span class="line">        img_tensor = Variable(torch.unsqueeze(img_tensor, dim=<span class="number">0</span>).<span class="built_in">float</span>(), requires_grad=<span class="literal">False</span>).to(</span><br><span class="line">            device)  <span class="comment"># 增加图片的维度，之前是三维，模型要求四维</span></span><br><span class="line"></span><br><span class="line">        model.<span class="built_in">eval</span>()</span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            features = model(img_tensor)</span><br><span class="line">            features = features.detach().cpu().numpy()  <span class="comment"># 将tensor转为ndarry</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> features</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算两者距离</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">distance</span>(<span class="params">self,feture_1,feture_2</span>):</span><br><span class="line">        <span class="comment"># 两者之间的欧式公式</span></span><br><span class="line">        <span class="comment"># feture_1 = np.array(feture_1)</span></span><br><span class="line">        <span class="comment"># feture_2 = np.array(feture_2)</span></span><br><span class="line">        <span class="comment"># dist = np.sqrt(np.sum(np.square(feture_1-feture_2)))</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 使用两者之间的余弦距离</span></span><br><span class="line">        dist = np.dot(feture_1, feture_2) / (np.linalg.norm(feture_1) * np.linalg.norm(feture_2))</span><br><span class="line">        dist = np.arccos(dist)/math.pi</span><br><span class="line">        <span class="keyword">return</span> dist</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 主函数</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">eval</span>(<span class="params">self</span>):</span><br><span class="line">        device = <span class="string">&#x27;cuda&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span></span><br><span class="line">        model = MobileFaceNet()</span><br><span class="line">        model.to(device)</span><br><span class="line">        <span class="keyword">if</span> device == <span class="string">&quot;cpu&quot;</span>:</span><br><span class="line">            model.load_state_dict(torch.load(self.model_path, map_location=torch.device(<span class="string">&#x27;cpu&#x27;</span>)))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            model.load_state_dict(torch.load(self.model_path))</span><br><span class="line">        detector = dlib.get_frontal_face_detector()</span><br><span class="line">        cap = cv2.VideoCapture(<span class="number">0</span>)</span><br><span class="line">        probability = []</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">True</span>):</span><br><span class="line">            <span class="comment"># 摄像头读取图片</span></span><br><span class="line">            success, img = cap.read()</span><br><span class="line">            <span class="comment"># 灰度化</span></span><br><span class="line">            gray_img = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)</span><br><span class="line">            <span class="comment"># 调用检测器</span></span><br><span class="line">            dets = detector(gray_img, <span class="number">1</span>)</span><br><span class="line">            start_time = time.time()</span><br><span class="line">            <span class="keyword">if</span> dets <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">for</span> i, d <span class="keyword">in</span> <span class="built_in">enumerate</span>(dets):</span><br><span class="line">                    x1 = d.top() <span class="keyword">if</span> d.top() &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">                    y1 = d.bottom() <span class="keyword">if</span> d.bottom() <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">                    x2 = d.left() <span class="keyword">if</span> d.left() &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">                    y2 = d.right() <span class="keyword">if</span> d.right() &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">                    <span class="comment"># 截取脸部图片</span></span><br><span class="line">                    face = img[x1:y1, x2:y2]</span><br><span class="line">                    <span class="comment"># 改变图片大小</span></span><br><span class="line">                    face = cv2.resize(face,(FIG.picture_size,FIG.picture_size))</span><br><span class="line">                    features_1 = video.getVideoFeature(self,model,face,device)</span><br><span class="line">                    name_list,feature_list = video.load_feature(self)</span><br><span class="line">                    <span class="comment"># 每张图片都和读取到的特征向量进行一次对计算</span></span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(feature_list)):</span><br><span class="line">                        features_2 = feature_list[i]</span><br><span class="line">                        features_2 = np.array(features_2)</span><br><span class="line">                        num = video.distance(self,features_1,features_2)</span><br><span class="line">                        probability.append(num)</span><br><span class="line">                    <span class="comment"># print(probability)  # 打印和各特征向量比例，越低相似度越高</span></span><br><span class="line">                    min_pro = <span class="built_in">min</span>(probability)  <span class="comment"># 获取最低的比例</span></span><br><span class="line">                    index = probability.index(min_pro)</span><br><span class="line">                    user_name = name_list[index]</span><br><span class="line">                    probability.clear() <span class="comment"># 一张图片对比完成及时清除，避免对下一张图片造成影响</span></span><br><span class="line">                    <span class="keyword">if</span> min_pro &lt;= self.face_confidence:</span><br><span class="line">                        cv2.putText(img, <span class="built_in">str</span>(user_name), (y2,y1-<span class="number">50</span>), cv2.FONT_HERSHEY_SIMPLEX, <span class="number">1</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">2</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        cv2.putText(img, <span class="built_in">str</span>(<span class="string">&quot;Unknow&quot;</span>), (y2, y1 - <span class="number">50</span>), cv2.FONT_HERSHEY_SIMPLEX, <span class="number">1</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">2</span>)</span><br><span class="line">                    img = cv2.rectangle(img,(y2,y1),(x2,x1),(<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line">            end_time = time.time()</span><br><span class="line">            use_time = end_time-start_time</span><br><span class="line">            <span class="keyword">if</span> (use_time != <span class="number">0</span>):</span><br><span class="line">                FPS = <span class="number">1</span>/(end_time-start_time)</span><br><span class="line">                cv2.putText(img,<span class="string">&quot;PFS:&#123;:.2f&#125;&quot;</span>.<span class="built_in">format</span>(FPS),(<span class="number">10</span>,<span class="number">30</span>),cv2.FONT_HERSHEY_SIMPLEX,<span class="number">1</span>,(<span class="number">255</span>,<span class="number">0</span>,<span class="number">255</span>),<span class="number">2</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                cv2.putText(img,<span class="string">&quot;PFS:----&quot;</span> , (<span class="number">10</span>, <span class="number">30</span>), cv2.FONT_HERSHEY_SIMPLEX, <span class="number">1</span>, (<span class="number">255</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">2</span>)</span><br><span class="line">            cv2.imshow(<span class="string">&quot;img&quot;</span>,img)</span><br><span class="line">            <span class="keyword">if</span> cv2.waitKeyEx(<span class="number">1</span>) == <span class="built_in">ord</span>(<span class="string">&#x27;q&#x27;</span>):  <span class="comment"># 如果按下‘q’则推出</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 参数设置</span></span><br><span class="line">    feature_path = FIG.feature_path</span><br><span class="line">    picture_size = FIG.picture_size</span><br><span class="line">    face_confidence = FIG.face_confidence</span><br><span class="line">    model_path = FIG.test_feature_model_path</span><br><span class="line">    V = video(model_path=model_path,feature_path=feature_path,picture_size=picture_size,face_confidence=face_confidence)</span><br><span class="line">    V.<span class="built_in">eval</span>()</span><br></pre></td></tr></table></figure>



<p>另一个轻量级模型</p>
<h1 id="Squeezenet"><a href="#Squeezenet" class="headerlink" title="Squeezenet"></a>Squeezenet</h1><h2 id="网络结构"><a href="#网络结构" class="headerlink" title="网络结构"></a>网络结构</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.init <span class="keyword">as</span> init</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .utils.log_api <span class="keyword">import</span> _log_api_usage_once</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Fire</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, inplanes: <span class="built_in">int</span>, squeeze_planes: <span class="built_in">int</span>, expand1x1_planes: <span class="built_in">int</span>, expand3x3_planes: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.inplanes = inplanes</span><br><span class="line">        self.squeeze = nn.Conv2d(inplanes, squeeze_planes, kernel_size=<span class="number">1</span>)</span><br><span class="line">        self.squeeze_activation = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line">        self.expand1x1 = nn .Conv2d(squeeze_planes, expand1x1_planes, kernel_size=<span class="number">1</span>)</span><br><span class="line">        self.expand1x1_activation = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line">        self.expand3x3 = nn.Conv2d(squeeze_planes, expand3x3_planes, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>)</span><br><span class="line">        self.expand3x3_activation = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor</span>) -&gt; torch.Tensor:</span><br><span class="line">        x = self.squeeze_activation(self.squeeze(x))</span><br><span class="line">        <span class="keyword">return</span> torch.cat(</span><br><span class="line">            [self.expand1x1_activation(self.expand1x1(x)), self.expand3x3_activation(self.expand3x3(x))], <span class="number">1</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SqueezeNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, version: <span class="built_in">str</span> = <span class="string">&quot;1_0&quot;</span>, num_classes: <span class="built_in">int</span> = <span class="number">1000</span>, dropout: <span class="built_in">float</span> = <span class="number">0.5</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        _log_api_usage_once(self)</span><br><span class="line">        self.num_classes = num_classes</span><br><span class="line">        <span class="keyword">if</span> version == <span class="string">&quot;1_0&quot;</span>:</span><br><span class="line">            self.features = nn.Sequential(</span><br><span class="line">                nn.Conv2d(<span class="number">3</span>, <span class="number">96</span>, kernel_size=<span class="number">7</span>, stride=<span class="number">2</span>),</span><br><span class="line">                nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">                nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, ceil_mode=<span class="literal">True</span>),</span><br><span class="line">                Fire(<span class="number">96</span>, <span class="number">16</span>, <span class="number">64</span>, <span class="number">64</span>),</span><br><span class="line">                Fire(<span class="number">128</span>, <span class="number">16</span>, <span class="number">64</span>, <span class="number">64</span>),</span><br><span class="line">                Fire(<span class="number">128</span>, <span class="number">32</span>, <span class="number">128</span>, <span class="number">128</span>),</span><br><span class="line">                nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, ceil_mode=<span class="literal">True</span>),</span><br><span class="line">                Fire(<span class="number">256</span>, <span class="number">32</span>, <span class="number">128</span>, <span class="number">128</span>),</span><br><span class="line">                Fire(<span class="number">256</span>, <span class="number">48</span>, <span class="number">192</span>, <span class="number">192</span>),</span><br><span class="line">                Fire(<span class="number">384</span>, <span class="number">48</span>, <span class="number">192</span>, <span class="number">192</span>),</span><br><span class="line">                nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, ceil_mode=<span class="literal">True</span>),</span><br><span class="line">                Fire(<span class="number">384</span>, <span class="number">64</span>, <span class="number">256</span>, <span class="number">256</span>),</span><br><span class="line">                Fire(<span class="number">512</span>, <span class="number">64</span>, <span class="number">256</span>, <span class="number">256</span>),</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">elif</span> version == <span class="string">&quot;1_1&quot;</span>:</span><br><span class="line">            self.features = nn.Sequential(</span><br><span class="line">                nn.Conv2d(<span class="number">3</span>, <span class="number">64</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>),</span><br><span class="line">                nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">                nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, ceil_mode=<span class="literal">True</span>),</span><br><span class="line">                Fire(<span class="number">64</span>, <span class="number">16</span>, <span class="number">64</span>, <span class="number">64</span>),</span><br><span class="line">                Fire(<span class="number">128</span>, <span class="number">16</span>, <span class="number">64</span>, <span class="number">64</span>),</span><br><span class="line">                nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, ceil_mode=<span class="literal">True</span>),</span><br><span class="line">                Fire(<span class="number">128</span>, <span class="number">32</span>, <span class="number">128</span>, <span class="number">128</span>),</span><br><span class="line">                Fire(<span class="number">256</span>, <span class="number">32</span>, <span class="number">128</span>, <span class="number">128</span>),</span><br><span class="line">                nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, ceil_mode=<span class="literal">True</span>),</span><br><span class="line">                Fire(<span class="number">256</span>, <span class="number">48</span>, <span class="number">192</span>, <span class="number">192</span>),</span><br><span class="line">                Fire(<span class="number">384</span>, <span class="number">48</span>, <span class="number">192</span>, <span class="number">192</span>),</span><br><span class="line">                Fire(<span class="number">384</span>, <span class="number">64</span>, <span class="number">256</span>, <span class="number">256</span>),</span><br><span class="line">                Fire(<span class="number">512</span>, <span class="number">64</span>, <span class="number">256</span>, <span class="number">256</span>),</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># <span class="doctag">FIXME:</span> Is this needed? SqueezeNet should only be called from the</span></span><br><span class="line">            <span class="comment"># <span class="doctag">FIXME:</span> squeezenet1_x() functions</span></span><br><span class="line">            <span class="comment"># <span class="doctag">FIXME:</span> This checking is not done for the other models</span></span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unsupported SqueezeNet version <span class="subst">&#123;version&#125;</span>: 1_0 or 1_1 expected&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Final convolution is initialized differently from the rest</span></span><br><span class="line">        final_conv = nn.Conv2d(<span class="number">512</span>, self.num_classes, kernel_size=<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        self.classifier = nn.Sequential(</span><br><span class="line">            nn.Dropout(p=dropout), final_conv, nn.ReLU(inplace=<span class="literal">True</span>), nn.AdaptiveAvgPool2d((<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, nn.Conv2d):</span><br><span class="line">                <span class="keyword">if</span> m <span class="keyword">is</span> final_conv:</span><br><span class="line">                    init.normal_(m.weight, mean=<span class="number">0.0</span>, std=<span class="number">0.01</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    init.kaiming_uniform_(m.weight)</span><br><span class="line">                <span class="keyword">if</span> m.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    init.constant_(m.bias, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor</span>) -&gt; torch.Tensor:</span><br><span class="line">        x = self.features(x)</span><br><span class="line">        x = self.classifier(x)</span><br><span class="line">        <span class="keyword">return</span> torch.flatten(x, <span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="微调"><a href="#微调" class="headerlink" title="微调"></a>微调</h2><p>对最后一层进行微调，尚未是最终版</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ### 导入相关的包</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># In[2]:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset, DataLoader</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> torch.optim.lr_scheduler <span class="keyword">import</span> LambdaLR,ReduceLROnPlateau</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> datasets</span><br><span class="line"><span class="keyword">from</span> sklearn.neighbors <span class="keyword">import</span> NearestNeighbors</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> TripletMarginLoss</span><br><span class="line"><span class="keyword">import</span> torch.nn.init <span class="keyword">as</span> init</span><br><span class="line"><span class="keyword">from</span> torch.utils.tensorboard <span class="keyword">import</span> SummaryWriter</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_train</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Start Training&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span>*<span class="number">10</span>)</span><br><span class="line">    <span class="comment"># 用mx来记录最大的acc值</span></span><br><span class="line">    mx=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(epochs):</span><br><span class="line">        <span class="comment"># print(&#x27;\n循环 &#123;&#125;/&#123;&#125;&#x27;.format(epoch + 1, epochs))</span></span><br><span class="line">        <span class="comment"># print(&#x27;-&#x27; * 10)</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./res.txt&#x27;</span>,<span class="string">&#x27;a+&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(<span class="string">f&#x27;\n循环 <span class="subst">&#123;epoch + <span class="number">1</span>&#125;</span>/<span class="subst">&#123;epochs&#125;</span>\n&#x27;</span>)</span><br><span class="line">            f.write(<span class="string">&#x27;------------------------------------------------------------------------------------\n&#x27;</span> )</span><br><span class="line">        </span><br><span class="line">        model.train()</span><br><span class="line">        <span class="comment"># 代价损失计算并且保存在结果文件中</span></span><br><span class="line">        cost_loss=<span class="number">0</span></span><br><span class="line">        <span class="comment"># 用来计算被划分了多少个批次</span></span><br><span class="line">        cnt=<span class="number">0</span></span><br><span class="line">        running_loss = <span class="number">0.0</span></span><br><span class="line">        <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(train_loader, <span class="number">0</span>):</span><br><span class="line">            anchor, positive, negative = data[<span class="number">0</span>]</span><br><span class="line">            anchor, positive, negative = anchor.to(<span class="string">&#x27;cuda&#x27;</span>), positive.to(<span class="string">&#x27;cuda&#x27;</span>), negative.to(<span class="string">&#x27;cuda&#x27;</span>)</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line">            anchor_out = model(anchor)</span><br><span class="line">            positive_out = model(positive)</span><br><span class="line">            negative_out = model(negative)</span><br><span class="line">            loss_val = loss(anchor_out, positive_out, negative_out)</span><br><span class="line">            loss_val.backward()</span><br><span class="line">            optimizer.step()</span><br><span class="line">            running_loss += loss_val.item()</span><br><span class="line">            <span class="comment"># writer.iteration += 1</span></span><br><span class="line">            <span class="comment"># print(f&quot;the loss is &#123;running_loss&#125;&quot;)</span></span><br><span class="line">            cost_loss+=running_loss</span><br><span class="line">            cnt+=<span class="number">1</span></span><br><span class="line">            <span class="comment"># 不知道干嘛的</span></span><br><span class="line">            <span class="comment"># if i % 10 == 9:</span></span><br><span class="line">            <span class="comment">#     # writer.add_scalar(&#x27;loss&#x27;, running_loss / 10,</span></span><br><span class="line">            <span class="comment">#     #                   writer.iteration)</span></span><br><span class="line">            <span class="comment">#     running_loss = 0.0</span></span><br><span class="line">        <span class="comment"># print(&#x27;Epoch&#123;&#125; finished&#x27;.format(epoch))</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./res.txt&#x27;</span>,<span class="string">&#x27;a+&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(<span class="string">f&#x27;The cost_loss is <span class="subst">&#123;cost_loss/cnt/batch_size&#125;</span> \n Epoch<span class="subst">&#123;epoch&#125;</span> finished\n&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        model.<span class="built_in">eval</span>()</span><br><span class="line">        <span class="comment">## we use acc to evaluate the model</span></span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            <span class="comment"># 用标签来评估模型</span></span><br><span class="line">            total = <span class="number">0</span></span><br><span class="line">            correct = <span class="number">0</span></span><br><span class="line">            reference_embeddings_np = np.vstack([embedding.cpu().numpy() <span class="keyword">for</span> embedding <span class="keyword">in</span> reference_embeddings])</span><br><span class="line">            near_nn = NearestNeighbors(n_neighbors=<span class="number">1</span>, algorithm=<span class="string">&#x27;auto&#x27;</span>,metric=<span class="string">&#x27;euclidean&#x27;</span>,).fit(reference_embeddings_np)</span><br><span class="line">            <span class="comment"># use labels to evaluate the model</span></span><br><span class="line">            <span class="keyword">for</span> i,data <span class="keyword">in</span> <span class="built_in">enumerate</span>(test_loader,<span class="number">0</span>):</span><br><span class="line">                    anchor_validation, _, _ = data[<span class="number">0</span>]</span><br><span class="line">                    anchor_label, _, _ = data[<span class="number">1</span>]</span><br><span class="line">                    batch_sizes = anchor_validation.size(<span class="number">0</span>)</span><br><span class="line">                    total += batch_sizes</span><br><span class="line">                    anchor_validation = anchor_validation.to(<span class="string">&#x27;cuda&#x27;</span>)</span><br><span class="line">                    <span class="comment"># print(anchor.shape)</span></span><br><span class="line">                    anchor_out_validation = model(anchor_validation).cpu().detach().numpy()</span><br><span class="line">                    <span class="comment"># print(&#x27;anchor_out_validation:&#x27;, anchor_out_validation)</span></span><br><span class="line">                    distances, indices = near_nn.kneighbors(anchor_out_validation)</span><br><span class="line">                    indices = indices.reshape(-<span class="number">1</span>)</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(batch_sizes):</span><br><span class="line">                        <span class="keyword">if</span> reference_labels[indices[j]] == anchor_label[j]:</span><br><span class="line">                            correct += <span class="number">1</span></span><br><span class="line">            acc = correct / total</span><br><span class="line">            <span class="comment"># print(&#x27;acc:&#x27;, acc)</span></span><br><span class="line">            <span class="comment"># print(&#x27;correct:&#x27;, correct)</span></span><br><span class="line">            <span class="keyword">if</span> mx &lt; acc:</span><br><span class="line">                mx=acc</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./res.txt&#x27;</span>,<span class="string">&#x27;a+&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(<span class="string">f&#x27;acc: <span class="subst">&#123;acc&#125;</span>\n&#x27;</span>)</span><br><span class="line">                f.write(<span class="string">f&#x27;correct: <span class="subst">&#123;correct&#125;</span>\n&#x27;</span>)</span><br><span class="line">            <span class="comment"># writer.add_scalar(&#x27;acc&#x27;, acc, epoch)</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 用scheduler来更新学习率</span></span><br><span class="line">            scheduler.step(acc)</span><br><span class="line">            <span class="comment"># current_lr = scheduler.get_last_lr()</span></span><br><span class="line">            <span class="comment"># print(&quot;Current learning rate: &quot;, current_lr)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">#全都扔进去</span></span><br><span class="line">            <span class="comment"># print(&#x27;lr:&#x27;, optimizer.param_groups[0][&#x27;lr&#x27;])</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./res.txt&#x27;</span>,<span class="string">&#x27;a+&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(<span class="string">&#x27;lr: &#123;&#125;\n&#x27;</span>.<span class="built_in">format</span>(optimizer.param_groups[<span class="number">0</span>][<span class="string">&#x27;lr&#x27;</span>]))</span><br><span class="line">            </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Finished Training&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./res.txt&#x27;</span>,<span class="string">&#x27;a+&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">&#x27;finish training\n&#x27;</span>)</span><br><span class="line">        f.write(<span class="string">f&#x27;the max acc is <span class="subst">&#123;acc&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ### 部署模型，修改分类层</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># In[3]:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用预训练参数</span></span><br><span class="line"><span class="keyword">from</span> models.SqueezeNet <span class="keyword">import</span> SqueezeNet</span><br><span class="line"></span><br><span class="line">model = SqueezeNet(version=<span class="string">&quot;1_1&quot;</span>)</span><br><span class="line">model.load_state_dict(torch.load(<span class="string">&#x27;squeezenet1_1_weights.pth&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 冻结参数层</span></span><br><span class="line"><span class="keyword">for</span> param <span class="keyword">in</span> model.parameters():</span><br><span class="line">    param.requires_grad = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改最后一层</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(model.classifier[<span class="number">1</span>])</span><br><span class="line">final_conv = nn.Conv2d(<span class="number">512</span>, <span class="number">128</span>, kernel_size=<span class="number">1</span>)</span><br><span class="line">init.normal_(final_conv.weight, mean=<span class="number">0.0</span>, std=<span class="number">0.01</span>)</span><br><span class="line">init.constant_(final_conv.bias, <span class="number">0.0</span>)</span><br><span class="line">model.classifier[<span class="number">1</span>] = final_conv</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">model = model.to(<span class="string">&#x27;cuda&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> params <span class="keyword">in</span> model.classifier[<span class="number">1</span>].parameters():</span><br><span class="line">    params.requires_grad = <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 解冻模型的最后1个Fire模块</span></span><br><span class="line"><span class="keyword">for</span> param <span class="keyword">in</span> model.features[-<span class="number">1</span>:].parameters():</span><br><span class="line">    param.requires_grad = <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment"># print(model)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># In[4]:</span></span><br><span class="line"></span><br><span class="line">transforming = transforms.Compose([</span><br><span class="line">    transforms.Resize((<span class="number">224</span>, <span class="number">224</span>)),</span><br><span class="line">    <span class="comment"># 数据增强</span></span><br><span class="line">    transforms.RandomHorizontalFlip(),  <span class="comment"># 随机水平翻转，有助于人脸识别任务</span></span><br><span class="line">    transforms.RandomRotation(<span class="number">10</span>),  <span class="comment"># 随机旋转，-10到10度之间</span></span><br><span class="line">    transforms.ColorJitter(brightness=<span class="number">0.2</span>, contrast=<span class="number">0.2</span>, saturation=<span class="number">0.2</span>),  <span class="comment"># 随机调整亮度、对比度和饱和度</span></span><br><span class="line">    transforms.RandomAffine(degrees=<span class="number">0</span>, translate=(<span class="number">0.1</span>, <span class="number">0.1</span>), scale=(<span class="number">0.9</span>, <span class="number">1.1</span>), shear=<span class="number">10</span>),  <span class="comment"># 随机仿射变换</span></span><br><span class="line">    transforms.ToTensor(),</span><br><span class="line">    transforms.Normalize(mean=[<span class="number">0.485</span>, <span class="number">0.456</span>, <span class="number">0.406</span>], std=[</span><br><span class="line">                                 <span class="number">0.229</span>, <span class="number">0.224</span>, <span class="number">0.225</span>])</span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ### 读取并且定制数据集</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># In[5]:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">loss = TripletMarginLoss(margin=<span class="number">0.2</span>, p=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分割三元组数据集</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TripletFaceDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, image_folder,persons,transform=<span class="literal">None</span></span>):</span><br><span class="line">        self.image_folder = image_folder</span><br><span class="line">        self.transform = transform</span><br><span class="line">        self.persons = persons</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, _</span>):</span><br><span class="line">        anchor_person = random.choice(self.persons)</span><br><span class="line">        positive_person = anchor_person</span><br><span class="line">        negative_person = random.choice(self.persons)</span><br><span class="line">        <span class="keyword">while</span> negative_person == anchor_person:</span><br><span class="line">            negative_person = random.choice(self.persons)</span><br><span class="line"></span><br><span class="line">        anchor_img_path = random.choice(os.listdir(</span><br><span class="line">            os.path.join(self.image_folder, anchor_person)))</span><br><span class="line">        positive_img_path = random.choice(os.listdir(</span><br><span class="line">            os.path.join(self.image_folder, positive_person)))</span><br><span class="line">        negative_img_path = random.choice(os.listdir(</span><br><span class="line">            os.path.join(self.image_folder, negative_person)))</span><br><span class="line">        <span class="keyword">while</span> anchor_img_path == positive_img_path:</span><br><span class="line">            positive_img_path = random.choice(os.listdir(</span><br><span class="line">                os.path.join(self.image_folder, positive_person)))       </span><br><span class="line">        anchor_img = Image.<span class="built_in">open</span>(os.path.join(</span><br><span class="line">            self.image_folder, anchor_person, anchor_img_path))</span><br><span class="line">        positive_img = Image.<span class="built_in">open</span>(os.path.join(</span><br><span class="line">            self.image_folder, positive_person, positive_img_path))</span><br><span class="line">        negative_img = Image.<span class="built_in">open</span>(os.path.join(</span><br><span class="line">            self.image_folder, negative_person, negative_img_path))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 进行数据处理</span></span><br><span class="line">        transform = self.transform</span><br><span class="line">        anchor_img = transform(anchor_img)</span><br><span class="line">        positive_img = transform(positive_img)</span><br><span class="line">        negative_img = transform(negative_img)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (anchor_img, positive_img, negative_img),(anchor_person, positive_person, negative_person)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.persons) * <span class="number">5</span>  <span class="comment"># 假设每个人有5张图片</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切割数据集八二分</span></span><br><span class="line"></span><br><span class="line">batch_size = <span class="number">128</span></span><br><span class="line">epochs = <span class="number">50</span></span><br><span class="line">workers = <span class="number">0</span> <span class="keyword">if</span> os.name == <span class="string">&#x27;nt&#x27;</span> <span class="keyword">else</span> <span class="number">8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dataset = datasets.ImageFolder(<span class="string">&#x27;./data_cropped&#x27;</span>, transform=transforming)</span><br><span class="line">labels = os.listdir(<span class="string">&#x27;./data_cropped&#x27;</span>)   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">random.shuffle(labels)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">train_idx, test_idx = train_test_split(</span><br><span class="line">    labels, test_size=<span class="number">0.2</span>, random_state=<span class="number">42</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">train_dataset = TripletFaceDataset(</span><br><span class="line">    image_folder=<span class="string">&#x27;./data_cropped&#x27;</span>, persons=train_idx, transform=transforming</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">test_dataset = TripletFaceDataset(</span><br><span class="line">    image_folder=<span class="string">&#x27;./data_cropped&#x27;</span>, persons=test_idx, transform=transforming</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">train_loader = DataLoader(train_dataset, batch_size=batch_size, shuffle=<span class="literal">True</span>, num_workers=workers)</span><br><span class="line">test_loader = DataLoader(test_dataset, batch_size=batch_size, shuffle=<span class="literal">False</span>, num_workers=workers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># In[6]:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#模型训练前准备</span></span><br><span class="line"><span class="comment"># 定制优化器</span></span><br><span class="line"><span class="comment"># 0.00001</span></span><br><span class="line">optimizer = torch.optim.Adam(model.parameters(), lr=<span class="number">0.00001</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># def lambda_rule(epoch,max_epoch):</span></span><br><span class="line"><span class="comment">#     max_epoch = 20</span></span><br><span class="line"><span class="comment">#     return (1-epoch/max_epoch)**0.9 ##多项式衰减</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># scheduler = LambdaLR(optimizer, lr_lambda=lambda_rule)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#每两轮进行一次学习率的更新，寻找最优的学习率</span></span><br><span class="line">scheduler = ReduceLROnPlateau(optimizer, mode=<span class="string">&#x27;max&#x27;</span>, factor=<span class="number">0.5</span>, patience=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定制参考嵌入向量</span></span><br><span class="line">reference_embeddings = []</span><br><span class="line">reference_labels = []</span><br><span class="line">model.<span class="built_in">eval</span>()</span><br><span class="line"><span class="comment"># 遍历数据集每个文件夹，每个文件夹embeddings计算平均值，放进reference_embeddings,对应的标签放进reference_labels</span></span><br><span class="line"><span class="keyword">for</span> label <span class="keyword">in</span> labels:</span><br><span class="line">    label_embeddings = []</span><br><span class="line">    <span class="keyword">for</span> img_path <span class="keyword">in</span> os.listdir(os.path.join(<span class="string">&#x27;./data_cropped&#x27;</span>, label)):</span><br><span class="line">        img = Image.<span class="built_in">open</span>(os.path.join(<span class="string">&#x27;./data_cropped&#x27;</span>, label, img_path))</span><br><span class="line">        img = transforming(img).to(<span class="string">&#x27;cuda&#x27;</span>)</span><br><span class="line">        img = img.unsqueeze(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            embedding = model(img).cpu().detach().numpy()</span><br><span class="line">            label_embeddings.append(embedding)    </span><br><span class="line">    label_embeddings = np.array(label_embeddings)</span><br><span class="line">    np_mean = np.mean(label_embeddings, axis=<span class="number">0</span>)</span><br><span class="line">    tensor_mean = torch.from_numpy(np_mean).to(<span class="string">&#x27;cuda&#x27;</span>)</span><br><span class="line">    reference_embeddings.append(tensor_mean)</span><br><span class="line">    reference_labels.append(label)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(reference_embeddings)</span></span><br><span class="line"><span class="comment"># print(reference_labels)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ### 开始训练</span></span><br><span class="line"></span><br><span class="line">start_train()</span><br><span class="line"></span><br><span class="line"><span class="comment"># In[ ]:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># writer = SummaryWriter(&#x27;runs/triplet_loss_experiment&#x27;)</span></span><br><span class="line"><span class="comment"># writer.iteration, writer.interval = 0, 10</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># writer.close()</span></span><br></pre></td></tr></table></figure>


<p>利用三元组损失函数进行L2距离计算</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分割三元组数据集</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TripletFaceDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, image_folder,persons,transform=<span class="literal">None</span></span>):</span><br><span class="line">        self.image_folder = image_folder</span><br><span class="line">        self.transform = transform</span><br><span class="line">        self.persons = persons</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, _</span>):</span><br><span class="line">        anchor_person = random.choice(self.persons)</span><br><span class="line">        positive_person = anchor_person</span><br><span class="line">        negative_person = random.choice(self.persons)</span><br><span class="line">        <span class="keyword">while</span> negative_person == anchor_person:</span><br><span class="line">            negative_person = random.choice(self.persons)</span><br><span class="line"></span><br><span class="line">        anchor_img_path = random.choice(os.listdir(</span><br><span class="line">            os.path.join(self.image_folder, anchor_person)))</span><br><span class="line">        positive_img_path = random.choice(os.listdir(</span><br><span class="line">            os.path.join(self.image_folder, positive_person)))</span><br><span class="line">        negative_img_path = random.choice(os.listdir(</span><br><span class="line">            os.path.join(self.image_folder, negative_person)))</span><br><span class="line">        <span class="keyword">while</span> anchor_img_path == positive_img_path:</span><br><span class="line">            positive_img_path = random.choice(os.listdir(</span><br><span class="line">                os.path.join(self.image_folder, positive_person)))       </span><br><span class="line">        anchor_img = Image.<span class="built_in">open</span>(os.path.join(</span><br><span class="line">            self.image_folder, anchor_person, anchor_img_path))</span><br><span class="line">        positive_img = Image.<span class="built_in">open</span>(os.path.join(</span><br><span class="line">            self.image_folder, positive_person, positive_img_path))</span><br><span class="line">        negative_img = Image.<span class="built_in">open</span>(os.path.join(</span><br><span class="line">            self.image_folder, negative_person, negative_img_path))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 进行数据处理</span></span><br><span class="line">        transform = self.transform</span><br><span class="line">        anchor_img = transform(anchor_img)</span><br><span class="line">        positive_img = transform(positive_img)</span><br><span class="line">        negative_img = transform(negative_img)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (anchor_img, positive_img, negative_img),(anchor_person, positive_person, negative_person)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.persons) * <span class="number">5</span>  <span class="comment"># 假设每个人有5张图片</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="微调的训练过程："><a href="#微调的训练过程：" class="headerlink" title="微调的训练过程："></a>微调的训练过程：</h3><p><img src="C:\Users\86176\AppData\Roaming\Typora\typora-user-images\image-20240223115703500.png" alt="image-20240223115703500"></p>
<h3 id="训练结果："><a href="#训练结果：" class="headerlink" title="训练结果："></a>训练结果：</h3><p><img src="C:\Users\86176\AppData\Roaming\Typora\typora-user-images\image-20240223115757242.png" alt="image-20240223115757242"></p>
<p><img src="C:\Users\86176\AppData\Roaming\Typora\typora-user-images\image-20240223115831484.png" alt="image-20240223115831484"></p>
<h1 id="虽然结果不太好，但是"><a href="#虽然结果不太好，但是" class="headerlink" title="虽然结果不太好，但是"></a>虽然结果不太好，但是</h1><h1 id="The-road-to-success-is-filled-with-hardships-but-perseverance-will-eventually-lead-to-success"><a href="#The-road-to-success-is-filled-with-hardships-but-perseverance-will-eventually-lead-to-success" class="headerlink" title="The road to success is filled with hardships, but perseverance will eventually lead to success."></a>The road to success is filled with hardships, but perseverance will eventually lead to success.</h1>
            <div class="post-copyright">
    <div class="content">
        <p>最后更新： 2024年02月23日 12:01</p>
        <p>原始链接： <a class="post-url" href="/Richo.github.io/2023/11/13/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%EF%BC%9A/" title="深度学习">https://bztiangou.github.io/Richo.github.io/2023/11/13/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%EF%BC%9A/</a></p>
        <footer>
            <a href="https://bztiangou.github.io/Richo.github.io">
                <img src="/Richo.github.io/images/head.jpg" alt="Richo">
                Richo
            </a>
        </footer>
    </div>
</div>

      
        
            
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;">赏</a>
</div>

<div id="reward" class="post-modal reward-lay">
    <a class="close" href="javascript:;" id="reward-close">×</a>
    <span class="reward-title">
        <i class="icon icon-quote-left"></i>
        请我吃糖~
        <i class="icon icon-quote-right"></i>
    </span>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/Richo.github.io/images/wechatpay.jpg" alt="打赏二维码">
        </div>
        <div class="reward-select">
            
            <label class="reward-select-item checked" data-id="wechat" data-wechat="/Richo.github.io/images/wechatpay.jpg">
                <img class="reward-select-item-wechat" src="/Richo.github.io/images/wechat.png" alt="微信">
            </label>
            
            
            <label class="reward-select-item" data-id="alipay" data-alipay="/Richo.github.io/images/zhifubao.jpg">
                <img class="reward-select-item-alipay" src="/Richo.github.io/images/alipay.png" alt="支付宝">
            </label>
            
        </div>
    </div>
</div>


        
    </div>
    <footer class="article-footer">
        
        
<div class="post-share">
    <a href="javascript:;" id="share-sub" class="post-share-fab">
        <i class="fa fa-share-alt"></i>
    </a>
    <div class="post-share-list" id="share-list">
        <ul class="share-icons">
          <li>
            <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://bztiangou.github.io/Richo.github.io/2023/11/13/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%EF%BC%9A/&title=《深度学习》 — Richo blog&pic=/images/banner.jpg" data-title="微博">
              <i class="fa fa-weibo"></i>
            </a>
          </li>
          <li>
            <a class="weixin share-sns" id="wxFab" href="javascript:;" data-title="微信">
              <i class="fa fa-weixin"></i>
            </a>
          </li>
          <li>
            <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://bztiangou.github.io/Richo.github.io/2023/11/13/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%EF%BC%9A/&title=《深度学习》 — Richo blog&source=有需自取，拒绝打赏" data-title="QQ">
              <i class="fa fa-qq"></i>
            </a>
          </li>
          <li>
            <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://bztiangou.github.io/Richo.github.io/2023/11/13/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%EF%BC%9A/" data-title="Facebook">
              <i class="fa fa-facebook"></i>
            </a>
          </li>
          <li>
            <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《深度学习》 — Richo blog&url=https://bztiangou.github.io/Richo.github.io/2023/11/13/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%EF%BC%9A/&via=https://bztiangou.github.io/Richo.github.io" data-title="Twitter">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
          <li>
            <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://bztiangou.github.io/Richo.github.io/2023/11/13/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%EF%BC%9A/" data-title="Google+">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        </ul>
     </div>
</div>
<div class="post-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;" id="wxShare-close">×</a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://bztiangou.github.io/Richo.github.io/2023/11/13/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%EF%BC%9A/" alt="微信分享二维码">
</div>

<div class="mask"></div>

        
        <ul class="article-footer-menu">
            
            
  <li class="article-footer-tags">
    <i class="fa fa-tags"></i>
      
    <a href="/Richo.github.io/tags/大创/" class="color3">大创</a>
      
    <a href="/Richo.github.io/tags/深度学习/" class="color5">深度学习</a>
      
  </li>

        </ul>
        
    </footer>
  </div>
</article>


    <aside class="post-toc-pos post-toc-top" id="post-toc">
        <nav class="post-toc-wrap">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%EF%BC%9A"><span class="post-toc-text">深度学习：</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"><span class="post-toc-text">背景知识</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%92%8C%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9A"><span class="post-toc-text">卷积神经网络和神经网络的区别：</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%EF%BC%9A"><span class="post-toc-text">整体架构：</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E8%BE%93%E5%85%A5%E5%B1%82%EF%BC%9A%E5%AD%97%E9%9D%A2%E6%84%8F%E6%80%9D"><span class="post-toc-text">输入层：字面意思</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%8D%B7%E7%A7%AF%E5%B1%82%EF%BC%9A"><span class="post-toc-text">卷积层：</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%B1%A0%E5%8C%96%E5%B1%82%EF%BC%9A"><span class="post-toc-text">池化层：</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%85%A8%E8%BF%9E%E6%8E%A5%E5%B1%82FC%EF%BC%9A"><span class="post-toc-text">全连接层FC：</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C"><span class="post-toc-text">什么是神经网络</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E7%94%A8%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E8%BF%9B%E8%A1%8C%E7%9B%91%E7%9D%A3%E5%AD%A6%E4%B9%A0"><span class="post-toc-text">用神经网络进行监督学习</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%8C%E5%88%86%E5%88%86%E7%B1%BB%E7%AE%97%E6%B3%95"><span class="post-toc-text">二分分类算法</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#logistic-%E5%9B%9E%E5%BD%92"><span class="post-toc-text">logistic 回归</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E6%A6%82%E8%BF%B0%E5%92%8C%E8%A1%A8%E7%A4%BA"><span class="post-toc-text">神经网络的概述和表示</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%BF%80%E6%B4%BB%E5%87%BD%E6%95%B0"><span class="post-toc-text">激活函数</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E9%9A%8F%E6%9C%BA%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="post-toc-text">随机初始化</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%89%8D%E5%90%91%E5%92%8C%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD"><span class="post-toc-text">前向和反向传播</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%A0%B8%E5%AF%B9%E7%9F%A9%E9%98%B5%E7%BB%B4%E6%95%B0"><span class="post-toc-text">核对矩阵维数</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8%E6%B7%B1%E5%BA%A6%E8%A1%A8%E7%A4%BA"><span class="post-toc-text">为什么用深度表示</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%90%AD%E5%BB%BA%E6%A8%A1%E5%9D%97"><span class="post-toc-text">搭建模块</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%B6%85%E5%8F%82%E6%95%B0%E5%92%8C%E5%8F%82%E6%95%B0"><span class="post-toc-text">超参数和参数</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#mobilenetV2"><span class="post-toc-text">mobilenetV2</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%88%9B%E5%BB%BAmobilenetV2%E7%BD%91%E7%BB%9C%E7%BB%93%E6%9E%84"><span class="post-toc-text">创建mobilenetV2网络结构</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%A0%A1%E9%AA%8C%E5%8D%95%E4%B8%AA%E5%9B%BE%E7%89%87%E7%9A%84%E7%89%B9%E5%BE%81%E5%90%91%E9%87%8F%E6%8F%90%E5%8F%96"><span class="post-toc-text">校验单个图片的特征向量提取</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%89%E5%85%83%E7%BB%84%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0%E8%AE%A1%E7%AE%97%E9%83%A8%E5%88%86%EF%BC%9A"><span class="post-toc-text">三元组损失函数计算部分：</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%B0%83%E7%94%A8"><span class="post-toc-text">调用</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#mobilefacenet"><span class="post-toc-text">mobilefacenet</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%AE%9A%E4%B9%89MobileFaceNet%E6%A8%A1%E5%9E%8B"><span class="post-toc-text">定义MobileFaceNet模型:</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#arcface"><span class="post-toc-text">arcface</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%8E%B7%E5%8F%96%E5%88%9D%E5%A7%8B%E5%9B%BE%E7%89%87"><span class="post-toc-text">获取初始图片</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E7%89%B9%E5%BE%81%E5%90%91%E9%87%8F%E6%8F%90%E5%8F%96"><span class="post-toc-text">特征向量提取</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Squeezenet"><span class="post-toc-text">Squeezenet</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E7%BD%91%E7%BB%9C%E7%BB%93%E6%9E%84"><span class="post-toc-text">网络结构</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%BE%AE%E8%B0%83"><span class="post-toc-text">微调</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%BE%AE%E8%B0%83%E7%9A%84%E8%AE%AD%E7%BB%83%E8%BF%87%E7%A8%8B%EF%BC%9A"><span class="post-toc-text">微调的训练过程：</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%AE%AD%E7%BB%83%E7%BB%93%E6%9E%9C%EF%BC%9A"><span class="post-toc-text">训练结果：</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E8%99%BD%E7%84%B6%E7%BB%93%E6%9E%9C%E4%B8%8D%E5%A4%AA%E5%A5%BD%EF%BC%8C%E4%BD%86%E6%98%AF"><span class="post-toc-text">虽然结果不太好，但是</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#The-road-to-success-is-filled-with-hardships-but-perseverance-will-eventually-lead-to-success"><span class="post-toc-text">The road to success is filled with hardships, but perseverance will eventually lead to success.</span></a></li></ol>
        </nav>
    </aside>
    

<nav id="article-nav">
  
    <a href="/Richo.github.io/2024/04/11/%E6%95%B0%E6%8D%AE%E5%BA%93/" id="article-nav-newer" class="article-nav-link-wrap">

      <span class="article-nav-title">
        <i class="fa fa-hand-o-left" aria-hidden="true"></i>
        
          数据库
        
      </span>
    </a>
  
  
    <a href="/Richo.github.io/2023/10/23/%E8%BD%AF%E5%AF%BC%E6%9C%9F%E6%9C%AB%E8%80%83%E9%87%8D%E7%82%B9/" id="article-nav-older" class="article-nav-link-wrap">
      <span class="article-nav-title">软导期末考重点（持续更新版本）</span>
      <i class="fa fa-hand-o-right" aria-hidden="true"></i>
    </a>
  
</nav>



    
</section>
        
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


      <p>
        Powered by  <a href="http://hexo.io/" target="_blank">Hexo</a>
        Theme <a href="//github.com/wongminho/hexo-theme-miho" target="_blank">MiHo</a>
      &copy; 2024 Richo<br>
      </p>
    </div>
  </div>
</footer>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script>
  var mihoConfig = {
      root: "https://bztiangou.github.io/Richo.github.io",
      animate: true,
      isHome: false,
      share: true,
      reward: 1
  }
</script>
<div class="sidebar">
    <div id="sidebar-search" title="Search">
        <i class="fa fa-search"></i>
    </div>
    <div id="sidebar-category" title="Categories">
        <i class="fa fa-book"></i>
    </div>
    <div id="sidebar-tag" title="Tags">
        <i class="fa fa-tags"></i>
    </div>
    <div id="sidebar-top">
        <span class="sidebar-top-icon"><i class="fa fa-angle-up"></i></span>
    </div>
</div>
<div class="sidebar-menu-box" id="sidebar-menu-box">
    <div class="sidebar-menu-box-container">
        <div id="sidebar-menu-box-categories">
            <a class="category-link" href="/Richo.github.io/categories/C-%EF%BC%8C%E5%BC%80%E5%8F%91%E5%BA%95%E5%B1%82/">C++，开发底层</a><a class="category-link" href="/Richo.github.io/categories/CS/">CS</a><a class="category-link" href="/Richo.github.io/categories/CS%EF%BC%8CCSS%EF%BC%8CXML/">CS，CSS，XML</a><a class="category-link" href="/Richo.github.io/categories/CS%EF%BC%8Cmath/">CS，math</a><a class="category-link" href="/Richo.github.io/categories/CS%EF%BC%8C%E6%95%B0%E5%AD%97%E7%94%B5%E8%B7%AF/">CS，数字电路</a><a class="category-link" href="/Richo.github.io/categories/JAVA/">JAVA</a><a class="category-link" href="/Richo.github.io/categories/Python/">Python</a><a class="category-link" href="/Richo.github.io/categories/Python%EF%BC%8C%E5%BC%80%E5%8F%91/">Python，开发</a><a class="category-link" href="/Richo.github.io/categories/language/">language</a><a class="category-link" href="/Richo.github.io/categories/life/">life</a><a class="category-link" href="/Richo.github.io/categories/python%EF%BC%8Ccs/">python，cs</a><a class="category-link" href="/Richo.github.io/categories/sql/">sql</a><a class="category-link" href="/Richo.github.io/categories/web/">web</a><a class="category-link" href="/Richo.github.io/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">深度学习</a><a class="category-link" href="/Richo.github.io/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a><a class="category-link" href="/Richo.github.io/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B%E5%AF%BC%E8%AE%BA/">软件工程导论</a><a class="category-link" href="/Richo.github.io/categories/%E8%BD%AF%E5%AF%BC%E5%A4%A7%E4%BD%9C%E4%B8%9A/">软导大作业</a>
        </div>
        <div id="sidebar-menu-box-tags">
            <a href="/Richo.github.io/tags/life/" style="font-size: 10px;">life</a> <a href="/Richo.github.io/tags/python/" style="font-size: 10px;">python</a> <a href="/Richo.github.io/tags/web%E5%BC%80%E5%8F%91/" style="font-size: 10px;">web开发</a> <a href="/Richo.github.io/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" style="font-size: 16px;">人工智能</a> <a href="/Richo.github.io/tags/%E5%A4%A7%E5%88%9B/" style="font-size: 16px;">大创</a> <a href="/Richo.github.io/tags/%E5%AE%9E%E4%B9%A0/" style="font-size: 12px;">实习</a> <a href="/Richo.github.io/tags/%E5%BC%80%E5%8F%91/" style="font-size: 10px;">开发</a> <a href="/Richo.github.io/tags/%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">开发基础</a> <a href="/Richo.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/Richo.github.io/tags/%E6%96%87%E6%A1%A3%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">文档语言</a> <a href="/Richo.github.io/tags/%E6%9C%9F%E6%9C%AB%E8%80%83/" style="font-size: 20px;">期末考</a> <a href="/Richo.github.io/tags/%E6%9C%9F%E6%9C%AB%E8%80%83%E8%AF%95/" style="font-size: 14px;">期末考试</a> <a href="/Richo.github.io/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" style="font-size: 10px;">机器学习</a> <a href="/Richo.github.io/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" style="font-size: 10px;">深度学习</a> <a href="/Richo.github.io/tags/%E7%BC%96%E7%A8%8B%E8%A7%84%E8%8C%83/" style="font-size: 12px;">编程规范</a> <a href="/Richo.github.io/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 12px;">编程语言</a> <a href="/Richo.github.io/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" style="font-size: 10px;">编译器</a> <a href="/Richo.github.io/tags/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">网络基础</a> <a href="/Richo.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" style="font-size: 18px;">计算机基础</a> <a href="/Richo.github.io/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B%E5%AF%BC%E8%AE%BA/" style="font-size: 12px;">软件工程导论</a>
        </div>
    </div>
    <a href="javascript:;" class="sidebar-menu-box-close">&times;</a>
</div>
<div class="mobile-header-menu-nav" id="mobile-header-menu-nav">
    <div class="mobile-header-menu-container">
        <span class="title">Menus</span>
        <ul class="mobile-header-menu-navbar">
            
            <li>
                <a  href="/Richo.github.io/">
                    <i class="fa fa-home"></i><span>Home</span>
                </a>
            </li>
            
            <li>
                <a  href="/Richo.github.io/archives">
                    <i class="fa fa-archive"></i><span>Archives</span>
                </a>
            </li>
            
            <li>
                <a  href="/Richo.github.io/about">
                    <i class="fa fa-user"></i><span>About</span>
                </a>
            </li>
            
        </ul>
    </div>
    <div class="mobile-header-tag-container">
        <span class="title">Tags</span>
        <div id="mobile-header-container-tags">
            <a href="/Richo.github.io/tags/life/" style="font-size: 10px;">life</a> <a href="/Richo.github.io/tags/python/" style="font-size: 10px;">python</a> <a href="/Richo.github.io/tags/web%E5%BC%80%E5%8F%91/" style="font-size: 10px;">web开发</a> <a href="/Richo.github.io/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" style="font-size: 16px;">人工智能</a> <a href="/Richo.github.io/tags/%E5%A4%A7%E5%88%9B/" style="font-size: 16px;">大创</a> <a href="/Richo.github.io/tags/%E5%AE%9E%E4%B9%A0/" style="font-size: 12px;">实习</a> <a href="/Richo.github.io/tags/%E5%BC%80%E5%8F%91/" style="font-size: 10px;">开发</a> <a href="/Richo.github.io/tags/%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">开发基础</a> <a href="/Richo.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/Richo.github.io/tags/%E6%96%87%E6%A1%A3%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">文档语言</a> <a href="/Richo.github.io/tags/%E6%9C%9F%E6%9C%AB%E8%80%83/" style="font-size: 20px;">期末考</a> <a href="/Richo.github.io/tags/%E6%9C%9F%E6%9C%AB%E8%80%83%E8%AF%95/" style="font-size: 14px;">期末考试</a> <a href="/Richo.github.io/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" style="font-size: 10px;">机器学习</a> <a href="/Richo.github.io/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" style="font-size: 10px;">深度学习</a> <a href="/Richo.github.io/tags/%E7%BC%96%E7%A8%8B%E8%A7%84%E8%8C%83/" style="font-size: 12px;">编程规范</a> <a href="/Richo.github.io/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 12px;">编程语言</a> <a href="/Richo.github.io/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" style="font-size: 10px;">编译器</a> <a href="/Richo.github.io/tags/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">网络基础</a> <a href="/Richo.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" style="font-size: 18px;">计算机基础</a> <a href="/Richo.github.io/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B%E5%AF%BC%E8%AE%BA/" style="font-size: 12px;">软件工程导论</a>
        </div>
    </div>
</div>
<div class="search-wrap">
    <span class="search-close">&times;</span>
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
            <i class="icon icon-lg icon-chevron-left"></i>
        </a>
        <input class="search-field" placeholder="Search..." id="keywords">
        <a id="search-submit" href="javascript:;">
            <i class="fa fa-search"></i>
        </a>
    <div class="search-container" id="search-container">
        <ul class="search-result" id="search-result">
        </ul>
    </div>
</div>

<div id="search-tpl">
    <li class="search-result-item">
        <a href="{url}" class="search-item-li">
            <span class="search-item-li-title" title="{title}">{title}</span>
        </a>
    </li>
</div>

<script src="/Richo.github.io/js/search.js"></script>


<script src="/Richo.github.io/js/main.js"></script>



  <script src="//cdn.bootcss.com/particles.js/2.0.0/particles.min.js"></script>
  <div id="particles"></div>
  
<script src="/Richo.github.io/js/particles.js"></script>








  
<link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">

  <script src="//cdn.bootcss.com/scrollReveal.js/3.0.5/scrollreveal.js"></script>
  
<script src="/Richo.github.io/js/animate.js"></script>



  
<script src="/Richo.github.io/js/pop-img.js"></script>

  <script>
     $(".article-entry p img").popImg();
  </script>

  </div>
</body>
</html>